# 2026-01-06 — V5.4i1 — Fix System Health Pillars cleanup: “TaskWorker has been deleted”

Model: **gpt-5.2 (Codex extension)** — reasoning effort **medium**  
Justification: small, localized Qt lifecycle fix; no architecture changes.

---

## Goal

Fix startup/runtime exception:

`RuntimeError: wrapped C/C++ object of type TaskWorker has been deleted`

Observed at:

`app_ui/screens/system_health.py::_on_pillars_thread_finished`  
calling `self._pillars_worker.deleteLater()` after the underlying Qt object has already been deleted.

This is likely a **double-delete / late-call** after `worker.finished -> worker.deleteLater()` has already executed (or the worker was destroyed due to ownership).

---

## Touchlist

- `app_ui/screens/system_health.py` *(or the current System Health module path used in repo)*
- `tests/pillars/test_pillars_smoke.py` *(optional: add a small structure regression test)*
- `docs/codex_prompts/INDEX.md` (append entry)

---

## Forbidden list

- No new deps.
- No refactors of other thread systems.
- Do not change Pillars logic itself.

---

## Required fix (minimal + safe)

### 1) Ensure the worker is only scheduled for deletion once

In the Pillars thread wiring, keep (or add) these connections:

- `worker.finished.connect(worker.deleteLater)`  ✅
- `worker.error.connect(thread.quit)` ✅
- `worker.finished.connect(thread.quit)` ✅
- `thread.finished.connect(thread.deleteLater)` ✅

Then update `_on_pillars_thread_finished` so it **does not call** `self._pillars_worker.deleteLater()`.

Instead, `_on_pillars_thread_finished` should only:
- clear Python references (`self._pillars_worker = None`, `self._pillars_thread = None`)
- update UI state / enable buttons

Reason: by the time `thread.finished` fires, the worker has often already been deleted (or is scheduled to be), and calling `deleteLater()` again can raise the RuntimeError you hit.

### 2) Optional defensive guard (if you must keep deleteLater)

If for some reason the codebase cannot guarantee `worker.finished -> deleteLater`,
wrap the call:

```python
try:
    self._pillars_worker.deleteLater()
except RuntimeError:
    pass
```

…but preferred is **remove the call** from `_on_pillars_thread_finished`.

---

## Tests (optional but recommended)

Add a structure regression test (similar to the previous QThread test) that asserts:

- `_on_pillars_thread_finished` does **not** contain `.deleteLater()` calls on `_pillars_worker`.

This keeps the fix from regressing without needing Qt GUI tests in CI.

---

## Verification

### Automated
- `python -m pytest -q tests/pillars`

### Manual (Windows)
- `python -m app_ui.main`
- Open **System Health → Pillars**
- Click **Run pillars checks**
- Confirm:
  - No crash
  - No “TaskWorker has been deleted”
  - No QThread abort message

---

## Docs workflow

Append to `docs/codex_prompts/INDEX.md`:
- Date: 2026-01-06
- Version: V5.4i1
- Filename: `docs/codex_prompts/2026-01-06__V5.4i1__system_health__pillars_worker_deleted_guard.md`
- One-line purpose: “Fix System Health Pillars cleanup: avoid calling deleteLater on already-deleted TaskWorker.”
- After completion: add commit hash + notes.
