# Model
gpt-5.2-codex — reasoning_effort=medium

## Why this choice
This is targeted CodeSee UI polish across node rendering + small state plumbing (context vs activity) + a compact popover UI + one deterministic unit test. Medium effort is appropriate; bump to high only if the CodeSee node/scene architecture is tightly coupled.

---

## Goal
Implement **V5.5b1: Context-sticky highlight + on-node compressed status badges with dropdown**.

We already track the developer’s current screen context (e.g., SystemHealth/Runs, LabHost:<lab_id>, etc.). Now we want:

1) **Context highlight stays active while the developer is in that screen**
   - The node(s) mapped to the *current* screen context should remain highlighted **as long as that context is active**.
   - The highlight should **turn off immediately when leaving** the screen/context.
   - Crucially: this should NOT become “always-on forever”, and it should NOT decay while still in the context.

2) **Compressed on-node status badges**
   - Each node can display a small row of status icons on its top edge (max 3–4 visible).
   - If there are more statuses than the visible slots, show a compact overflow pill:
     - `5+` for 5 or more
     - `99+` cap when the count reaches >= 99
   - Clicking/hovering the badge row (or overflow pill) opens a **popover dropdown anchored to the node** listing what the icons/counts mean.

This is UI/UX polish that must not regress V5.5a (edge-following pulses) and must not make the node border highlight permanently “stuck” outside the active context.

---

## Acceptance criteria
### A) Context-sticky highlight
- While in a screen context that maps to a node (e.g., SystemHealth/Runs → core_center):
  - node border highlight remains visible continuously (no fade-out).
- When you navigate away:
  - border highlight disappears promptly (within one UI tick).
- Activity highlight still works (decay) and can layer on top, but **context highlight is authoritative while active**.

### B) Compressed badges + dropdown
- On a node, show up to N status icons (N=3 or 4).
- If more statuses are present:
  - show a pill `X+` where X is the total number of statuses (cap at `99+`).
- Opening the dropdown shows a list of statuses for that node, each with:
  - icon
  - label (e.g., “Current screen context”, “Recent activity”, “Pulses”, “Signals”…)
  - optional count
  - optional “last seen” timestamp
- Dropdown is anchored to the node and does not block the whole UI.
- Reduced clutter: we do NOT add infinite icons; overflow is compressed.

---

## Touchlist
(Discover actual filenames/classes in-repo; these are intent-level targets.)
- CodeSee **NodeItem** / node paint routine (where border + decorations render)
- CodeSee scene/controller state that tracks:
  - current screen context
  - node last-activity timestamps / pulses/signals
- Any existing “node overlay/badges” code (if present)
- A small popover UI implementation:
  - likely QMenu / QWidget popup anchored to node screen position
- Add 1 deterministic unit test for a new pure helper:
  - e.g., overflow label formatting (`5+`, `99+`)
  - or compressing a list of badge types into visible+overflow

Also update:
- `docs/codex_prompts/INDEX.md` (append entry; fill commit hash after landing)

---

## Forbidden list
- No major refactors/renames
- Don’t change runtime_bus/core_center/component_runtime unless strictly needed to read the already-produced screen context signal
- No schema/content repo edits
- No new heavy dependencies
- Don’t touch Pillars unless the end-of-milestone review says it’s warranted

---

## Implementation notes (do not skip)
### 1) Split “context highlight” from “activity highlight”
Right now border highlight appears to fade because it is driven by an activity-decay timer.

Implement two independent signals:
- `context_active`: boolean derived from current screen context mapping to node(s)
- `activity_alpha`: existing decay curve for recent activity

Border highlight alpha should be something like:
- `border_alpha = max(context_alpha, activity_alpha)`
- where `context_alpha` is **1.0** while active, **0.0** otherwise (no decay).

### 2) Context mapping behavior
Use the existing screen-context system you merged in V5.5b.
- Maintain a `current_context_nodes: set[node_id]` (or similar).
- Update it whenever screen context changes.
- Ensure a repaint is requested immediately after context changes.

### 3) Status badge model per node
Define a small list of “badge types” for a node (ordered by importance), e.g.:
- Current screen context (only for nodes in context set)
- Recent activity (if activity_alpha > 0)
- Pulses active (if pulses > 0)
- Signals (if signals > 0)
- Errors/warnings (if available)

Only show badges when:
- node is active (any badge present), OR
- node is hovered/selected (optional — only if it reduces clutter)

### 4) Compression rules
- Visible slots: N = 3 or 4 (pick one, keep consistent).
- If total_badges > N:
  - show first N-1 icons + overflow pill, OR show N icons + pill (choose whichever fits)
- Overflow pill label:
  - if total_badges >= 99 → `99+`
  - else if total_badges >= 5 → `{total_badges}+`
  - else (shouldn’t happen if overflow is shown) just show `{total_badges}`

Add a pure helper like:
- `format_overflow(total: int) -> str`

### 5) Popover dropdown anchored to node
- Trigger: click the overflow pill or badge strip; hover-to-preview is optional but nice.
- UI options:
  1) `QMenu` styled to match dark theme
  2) small `QFrame` popup with a `QListWidget` / custom paint
- Anchor at node top-right corner in scene coordinates transformed to screen coordinates.
- List entries show:
  - icon + label + optional count + optional “last seen”
- Include the “Current screen context: <context_id>” entry when context_active.

---

## Tests
Add 1 deterministic unit test for a pure helper:
- `format_overflow(5) == "5+"`
- `format_overflow(17) == "17+"`
- `format_overflow(99) == "99+"`
- `format_overflow(140) == "99+"`
Or similar compression mapping tests.

Avoid Qt scene/view instantiation in tests.

---

## Auto-verify (run these)
- `python -m compileall -q app_ui runtime_bus core_center component_runtime ui_system content_system diagnostics tools`
- `python -m pytest -q`

---

## Manual test checklist (must pass)
1) Launch: `python -m app_ui.main`
2) Open CodeSee and navigate:
   - System Health → Runs (or any context-mapped screen)
   - Confirm the mapped node border highlight stays ON while you remain there.
3) Navigate away (e.g., back to Main Menu / Content Browser):
   - Confirm the highlight turns OFF promptly.
4) On a node with multiple statuses:
   - Confirm icons compress after N slots into `5+` or `99+`
   - Open the dropdown and verify it explains icons/counts.
5) Confirm pulses still follow edges (no regression from V5.5a).

---

## End-of-milestone Pillars review
Ask: “Did V5.5b1 introduce something that deserves a Pillar check?”
- If no: do nothing.
- If yes: add ONE small deterministic Pillar check + unit test.
