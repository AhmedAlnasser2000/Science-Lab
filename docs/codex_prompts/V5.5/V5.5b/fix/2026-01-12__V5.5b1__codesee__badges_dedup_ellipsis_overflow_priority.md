# Model
gpt-5.2-codex — reasoning_effort=medium

## Why this choice
This is focused UI/UX polish inside CodeSee: badge strip layout rules, overflow visibility, ellipsis hinting, dropdown details, and a small deterministic helper test. Medium effort is appropriate.

---

## Goal
**V5.5b1 follow-up:** Improve CodeSee node badge strip and dropdown so it stays readable under load and never hides important indicators.

We already implemented badges + overflow pill, but we still have issues:
- Duplicate badges (same icon repeated) create clutter.
- Overflow pill can be occluded by temporary badges (`C/A/P`).
- When there isn’t enough space, badges silently disappear (no hint).
- Overflow label stays compact (good), but dropdown/hover must show exact counts.

This milestone keeps the V5.5b1 suffix (no need to bump to b2).

---

## Requirements
### 1) No duplicates on the badge strip (aggregate by type)
- The badge strip should show **unique badge types only** (e.g., one “muted” icon), not repeated instances.
- Counts (e.g., muted=8) are shown in the dropdown (and optionally as a tiny superscript/mini-count next to the icon if you already have that style, but keep it subtle).

### 2) Overflow pill must never be occluded
- The overflow pill (`8+`, `99+`) must always remain visible.
- Reserve its space first and draw it at the far-right of the badge strip (recommended).
- Draw other badges to the left of it (right-to-left layout) until space runs out.
- Clip rendering to the badge strip rect so nothing spills outside.

### 3) Ellipsis hint when items are hidden
- If there are additional badge types that cannot be shown due to space, draw a small **ellipsis marker** (`…`) in the badge strip.
- The ellipsis indicates “more items available in dropdown”.
- Hover tooltip for ellipsis: “More status items — open dropdown”.

### 4) Dropdown shows exact counts (no cap)
- The overflow pill label can remain capped (`99+`), but the dropdown/tooltip must show the **exact underlying totals**.
- Dropdown content should list:
  - icon
  - label (e.g., “Current screen context”, “Recent activity”, “Pulse active”, “Signals”, “Error”, “Activity muted”)
  - exact count if >1
  - optional “last seen” timestamp if you track it

### 5) Optional in-dropdown legend
- Add a small “Legend” section (collapsed or at bottom) explaining:
  - C = Current screen context
  - A = Recent activity
  - P = Pulse active
  - S = Signals
  - ! = Error
- Keep it minimal; don’t clutter the main list.

---

## Acceptance criteria
1) **Dedup works:** if 8 “activity.muted” events exist, the strip shows only one muted icon (not 8 copies).
2) **Overflow pill visibility:** pill is always visible and never blocked by other badges.
3) **Hidden hint:** when not all badge types fit, `…` appears.
4) **Truthful details:** hovering/clicking shows exact counts, even when pill shows `99+`.
5) **No regressions:** context-sticky node highlight (V5.5b1) still behaves correctly (stays highlighted only while in the mapped screen), and V5.5a edge-following pulses remain correct.

---

## Touchlist
- CodeSee NodeItem paint routine / badge strip renderer
- Badge aggregation model (per-node) and dropdown builder
- Any helper that formats overflow labels and chooses visible badges
- Unit tests: add/update one deterministic test for:
  - overflow label formatting, or
  - visible badge selection + ellipsis appearance conditions

---

## Forbidden list
- No major refactors or renames
- Don’t change runtime_bus/core_center/component_runtime
- No schema/content changes
- No new dependencies
- Don’t touch Pillars unless end-of-milestone review says it’s warranted

---

## Implementation notes
### Layout strategy (recommended)
- Compute aggregated badge entries: one per type (with count + last_ts).
- Compute `total_count = sum(counts)` and `total_types = len(types)`.
- Determine if overflow pill is needed based on total_count or hidden items after fitting.
- Reserve pill width, then place badges right-to-left.
- If some badge types are not shown due to width limit, set `hidden_types > 0` and render `…`.

### Priority order
- Overflow pill (always)
- C (context)
- ! (error)
- A (recent activity)
- P (pulse)
- S (signals)
- other badges…

### Tooltip / dropdown behavior
- Clicking the pill or `…` opens the dropdown.
- Dropdown lists aggregated entries with exact counts.

---

## Auto-verify
- `python -m compileall -q app_ui runtime_bus core_center component_runtime ui_system content_system diagnostics tools`
- `python -m pytest -q`

---

## Manual verification
1) Open CodeSee and force many repeated statuses on a node (e.g., muted activity).
2) Confirm only one muted icon shows on the strip.
3) Confirm overflow pill stays visible even with C/A/P present.
4) Shrink node width / increase badges until not all types fit:
   - confirm `…` appears
   - confirm dropdown lists all types/counts accurately

---

## Git checkpoint
git add -A
git commit -m "fix(V5.5b1) codesee badges dedup + ellipsis hint + overflow priority"
git push
