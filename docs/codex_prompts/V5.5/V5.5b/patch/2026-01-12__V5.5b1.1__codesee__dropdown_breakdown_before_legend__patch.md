# Model
gpt-5.2-codex — reasoning_effort=medium

## Why this choice
Small UI polish + correctness patch in CodeSee’s dropdown content. We need a short recon to identify why the legend is conditionally overriding the breakdown and then adjust the menu composition rules. Medium effort is sufficient.

---

## Goal
**V5.5b1.1 patch:** The CodeSee dropdown/popover is still “stuck” showing the legend in a way that effectively hides the breakdown when hovering/clicking the `8+` pill. We want the dropdown to show the **exact breakdown first**, and the legend as a secondary/help section—not replacing the breakdown.

Context: We already have a V5.5b1.1 “fix” prompt. This patch is a follow-up that corrects dropdown composition/UX.

---

## Desired behavior
When hovering/clicking the overflow pill `8+`:
1) Show **Total: 8** at the top.
2) Show the **exact breakdown list** (e.g., “Muted activity (8)”) immediately under Total.
3) Show the **legend** below the breakdown, separated visually (divider) or under a small “Legend” header.
4) The overflow label remains `8+` on the node (compact), but the dropdown must never be “stuck” showing only legend lines.

---

## Recon (must do first)
1) Find where the dropdown menu content is built (QMenu/QFrame popup).
2) Identify the conditional that decides whether to show:
   - breakdown entries vs legend entries
   - and why in the overflow-pill path the legend is taking over.
3) Confirm that the breakdown data exists at that moment (e.g., aggregated status list non-empty), and that it’s not being filtered out by:
   - “max visible items” constraints
   - “compressed mode” returning only overflow
   - or a mistaken reuse of the “legend-only” view for overflow pill

Add a brief comment near the fix explaining which condition caused the legend-first/legend-only view.

---

## Patch requirements
### A) Dropdown composition order (authoritative)
Always render in this order:
1) Total line
2) Breakdown list (all aggregated badge types with exact counts; no cap)
3) Divider
4) Legend block (optional)

### B) Legend must not block the breakdown
- Legend should never replace the breakdown unless breakdown is genuinely empty.
- If breakdown is empty (should be rare), show:
  - “No status details” + legend.

### C) Keep overflow cap only for the on-node label
- Only the on-node pill is capped (`99+`).
- Dropdown shows real totals (e.g., 143) and real per-type counts.

### D) Unit test (lightweight)
If you have pure helpers for menu rows:
- Add/update one deterministic test verifying that a menu model builder returns:
  - Total first
  - At least one breakdown entry before legend
Otherwise, skip tests (don’t instantiate Qt).

---

## Touchlist
- CodeSee dropdown/popover builder (the code that populates the menu)
- Any menu model/helper used to build lines/rows
- (Optional) unit test file for the menu model helper if it exists

---

## Forbidden list
- No major refactors
- No changes to runtime_bus/core_center/component_runtime
- No schema/content changes
- No new dependencies
- No Pillars changes

---

## Auto-verify
- `python -m compileall -q app_ui runtime_bus core_center component_runtime ui_system content_system diagnostics tools`
- `python -m pytest -q`

---

## Manual verification
1) Launch: `python -m app_ui.main`
2) Open CodeSee; ensure node has many statuses; hover/click `8+`.
3) Confirm dropdown shows:
   - Total: 8
   - Muted activity (8)
   - then legend below (not replacing it).
4) Repeat with multiple badge types to ensure breakdown list appears properly.

---

## Git checkpoint
git add -A
git commit -m "patch(V5.5b1.1) codesee dropdown breakdown before legend"
git push
