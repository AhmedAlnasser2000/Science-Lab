# V5.5c11 — CodeSee “More…” menu: CodeSee-scoped Diagnostics (Option A)

**Model:** `gpt-5.2-codex`  
**Reasoning effort:** `medium`  
**Why:** UI + small new dialog + light wiring + a small unit test. No large refactor.

---

## Goal

Implement **CodeSee-scoped diagnostics** accessible from the **Lenses palette “More…”** menu, using the **same visual style** as the current More menu (dark translucent panel with icon rows and separators).

This is **Option A**: diagnostics are **CodeSee-only** (NOT System Health / global).

---

## Visual reference (must match)

Use the user-provided screenshot of the “More…” menu style as the reference:
- Chat attachment: *More menu mock* (dark panel, icon rows, separators, “Coming soon” disabled rows).

Keep spacing, row height, icon placement, hover/pressed styling consistent with the existing menu.

---

## Requirements

### 1) Menu change
In the Lenses palette **More…** menu:

- Replace the current bottom action **“Copy Diagnostics”** with:
  - **Label:** `Diagnostics (CodeSee)…`
  - (or `Open CodeSee Diagnostics…` if you prefer, but keep it short)
- Keep it in the bottom section near “Clear Search / Clear Recent”.
- Clicking it opens the **CodeSee Diagnostics** UI.

> NOTE: “Add Lens…” and “Delete Lens…” remain **Coming soon** (no change required except maintaining the disabled look).

### 2) CodeSee Diagnostics UI (simple and safe)
Create a lightweight UI (prefer `QDialog` or a small `QWidget` window) that is:
- CodeSee scoped
- Safe to open repeatedly (either single-instance per CodeSee window, or allow multiple but don’t leak)
- Does not affect System Health
- Never triggers recursion or any aggressive logging loops

**Suggested layout** (keep it minimal but useful):
- Title: **CodeSee Diagnostics**
- Two tabs or sections:
  1) **Status**
  2) **Logs**

#### Status should show (best-effort; only what already exists)
- Build info (app version + git hash if available)
- CodeSee enabled/disabled state (and disable reason if present)
- Current **Lens** (id/name) + **Source**
- Graph stats: node count, edge count (or “N/A” if not loaded)
- Live mode / snapshot mode (if applicable)
- Bus connected state (if CodeSee has a bus indicator)
- “Last activity” timestamp if tracked
- Palette state: pinned/docked/floating, search query, matches count, recent lenses count

If any value isn’t available in current state, show `N/A` (do not crash).

#### Logs tab
Provide:
- A read-only text view showing last **N** CodeSee log lines (e.g., 200–500 lines).
- A “Copy” button that copies a **single diagnostics blob** to clipboard:
  - Status block + Logs block (last N lines).
- Optional: filter box to search within the logs (nice-to-have, not required).

**Important:** Capture logs without depending on stdout scraping.
- Implement a simple in-memory ring buffer for CodeSee logs (append-only; bounded).
- Wire existing CodeSee logging helper(s) to also append to this buffer.
- Ensure logging access is **recursion-safe**:
  - Avoid any code paths that call `str()` on pathological objects.
  - Avoid environment access that can recurse during exception hooks.
  - Use `os.environ.get(...)` in try/except if needed.

### 3) Wiring
- The “More…” menu action opens the diagnostics UI.
- The diagnostics UI should “snapshot” current status on open, and optionally refresh on demand (a “Refresh” button is fine).
- Do not add any new global menu entries outside CodeSee.

### 4) Tests (tiny, non-Qt OK)
Add **one** small test that is deterministic and doesn’t require launching the GUI:
- Expose a helper function like:
  - `codesee_diagnostics_snapshot(screen_or_state) -> dict`
  - or `format_codesee_diagnostics(...) -> str`
- Test asserts:
  - Output contains a header like “CodeSee Diagnostics”
  - Includes fields “Lens” and “Source” keys (even if `N/A`)
  - Output is stable (no exceptions)

---

## Touchlist

**Allowed to edit:**
- `app_ui/codesee/screen.py` (palette “More…” menu wiring)
- `app_ui/codesee/**` (add new diagnostics module/dialog; log buffer)
- `tests/**` (add a small unit test)
- `docs/codex_prompts/INDEX.md` (append entry)

**Preferred new files (if needed):**
- `app_ui/codesee/diagnostics.py` (snapshot + formatting helpers)
- `app_ui/codesee/diagnostics_dialog.py` (UI)
- `app_ui/codesee/log_buffer.py` (ring buffer), if you want to keep it clean

---

## Forbidden list

- Do **not** change `core_center/`, `runtime_bus/`, `kernel/` behavior.
- Do **not** modify System Health or Pillars.
- No broad refactors of CodeSee architecture.
- No new background threads.
- No changes to workspace policy rules.
- Avoid adding new third-party dependencies.

---

## Auto-verify

Run:
- `python -m compileall -q app_ui`
- `python -m pytest -q`

---

## Manual verify (important)

1) Launch: `python -m app_ui.main`
2) Open CodeSee and open the **Lenses palette**
3) Click **More…** and ensure the menu looks the same style as before.
4) Click **Diagnostics (CodeSee)…**
   - Dialog opens
   - Status shows Lens/Source and other fields (or `N/A`)
   - Logs area shows something (or “No logs yet”)
5) Click **Copy** (if in dialog) and paste somewhere to confirm content.
6) Close and re-open diagnostics; no leaks/crashes.

---

## Git checkpoint commands

After successful verification:
- `git add -A`
- `git commit -m "feat(V5.5c11) CodeSee diagnostics from More menu"`
- `git push`
