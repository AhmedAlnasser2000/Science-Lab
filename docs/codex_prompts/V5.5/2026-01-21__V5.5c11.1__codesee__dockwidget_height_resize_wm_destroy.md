# Model
**gpt-5.2-codex** (reasoning_effort = **high**) — docking/float/resize behavior is subtle Qt state across multiple event paths; use high to recon precisely, fix safely, and add regression coverage.

# Goal
Fix the CodeSee **Lens Palette** so it:

1) **Resizes in height** correctly (floating + docked) — currently width works but height-resize triggers Windows/Qt console spam like:
   `External WM_DESTROY received for QWidgetWindow(... name="codeseeLensPaletteDockWindow" ...)`
2) **Does not fight the user** (no forced min/max height clamps after docking).
3) Keeps existing palette UI and safety guards already merged (pin recursion guard, safe-mode, etc.).
4) Ignore splitter polish for “two side docked panels” for now (out of scope).

Reference repro artifacts (local paths on Ahmed’s machine / attachments in this chat):
- Resize bug video: `e9d4e2c4-fc32-418b-96a0-6ef56267cebe.mp4`
- Console snippet screenshot: `ce8e5ae5-bdd8-498a-b05d-9ff2b9265cde.png`

# Touchlist
- `app_ui/codesee/screen.py` (Lens palette dockwidget creation, dock/float handlers, sizing, signals)
- Any CodeSee-specific UI helpers the palette uses (only if required)
- Add a small regression unit test under `tests/` (keep it deterministic; no full GUI harness needed)
- `docs/codex_prompts/INDEX.md` (append entry for this prompt)

# Forbidden
- Do **not** refactor unrelated CodeSee features (atlas rendering, pulses, session recording, etc.).
- Do **not** change global app docking rules outside CodeSee unless strictly needed.
- Do **not** remove the existing recursion/safe-mode guards (only extend if necessary).
- Do **not** add new dependencies.

# Recon
1) **Find where the WM_DESTROY line originates**:
   - Ripgrep: `WM_DESTROY`, `External WM_DESTROY`, `codeseeLensPaletteDockWindow`
   - Determine if it’s Qt plugin logging or our own `nativeEvent` / message hook.
2) Locate the palette dock widget and sizing logic:
   - Search for: `QDockWidget`, `setAllowedAreas`, `setFeatures`, `resizeDocks`,
     `setMinimumHeight`, `setMaximumHeight`, `setFixedHeight`, `setSizePolicy`,
     `topLevelChanged`, `dockLocationChanged`, `visibilityChanged`, `eventFilter`, `resizeEvent`.
3) Reproduce in code mentally:
   - When user drags the bottom edge to change height, what code path runs?
   - Do we call `resizeDocks()` or apply min-height clamps repeatedly (e.g., from a timer or from `resizeEvent`)?

# Likely root cause (hypothesis to validate)
We are **applying “normalization” to dock sizes** too aggressively (or with the wrong orientation),
and/or leaving a **minimum height** constraint in place, causing vertical resizing to fight back.
In the worst case, a re-entrant resize/geometry update during a native Windows resize can cause
Qt to destroy/recreate the underlying `QWidgetWindow` (hence the WM_DESTROY message).

# Implementation plan
## A) Make sizing rules orientation-correct and one-shot
1) Introduce a helper to choose normalization orientation based on the dock area:
   - Docked Left/Right → normalize **width only** (Qt.Horizontal)
   - Docked Top/Bottom → normalize **height only** (Qt.Vertical)
   - Floating → **do not normalize** via `resizeDocks`
2) Apply normalization **only on transitions**:
   - when docking area changes (`dockLocationChanged`)
   - when switching floating ↔ docked (`topLevelChanged`)
   Do **not** run normalization on every `resizeEvent`.

## B) Release constraints so user can resize
After applying any one-shot normalization, ensure we **don’t keep min/max height clamps**:
- Avoid `setFixedHeight` entirely.
- If we temporarily set min sizes, clear them after layout settles:
  - `QTimer.singleShot(0, ...)` (or 10–50ms) to restore min sizes to 0/default.
- Make sure the inner palette widget/scroll area does not have a permanent min height that blocks resizing.

## C) Guard against re-entrancy / resize storms
- Add a small boolean guard like `self._lens_palette_size_sync_in_progress`
  around normalization to prevent signal cascades.
- Never call `setFloating`, `restoreGeometry`, `restoreState`, or `setWidget`
  from inside a resize/paint/native-event path.

## D) Reduce the WM_DESTROY issue
Once A–C are in place, confirm whether WM_DESTROY disappears.
If it is from Qt and still appears harmlessly once, that’s OK — but it must not:
- close the palette,
- blank the UI,
- or spam continuously on height drag.

If it is from our code (hook/event), gate it behind `PHYSICSLAB_CODESEE_DEBUG=1` and/or remove it.

## E) Add a deterministic regression test
Add a small helper function (pure logic) and test it:
- `lens_palette_dock_orientation(area) -> Optional[Qt.Orientation]`
- Verify left/right => Horizontal, top/bottom => Vertical, none/unknown => None.
This ensures we don’t regress and start resizing in the wrong axis again.

# Auto-verify
Run:
- `python -m compileall -q app_ui`
- `python -m pytest -q`

# Manual verify (important)
1) Run: `python -m app_ui.main`
2) Open CodeSee (embedded and “Open in Window” variants)
3) Open Lens Palette; float it; drag-resize:
   - Height increases/decreases smoothly
   - No disappearing palette; no blank grid
   - No repeated WM_DESTROY spam
4) Dock to **left**, **right**, **top**, **bottom**:
   - Left/right: width normalization OK; height freely resizable
   - Top/bottom: height normalization OK; width freely resizable
5) Confirm pin/unpin and More menu still work (no recursion reintroduced)

# Git / PR workflow
Create a patch branch for this fix:

```bash
git checkout main
git pull
git checkout -b work/v5.5c11.1
git push -u origin work/v5.5c11.1
```

After changes:

```bash
git add -A
git commit -m "fix(V5.5c11.1) CodeSee lens palette height resize stability"
git push
```

Also append an entry to `docs/codex_prompts/INDEX.md` for this prompt (date, version, filename, one-line purpose; fill commit hash after merge).
