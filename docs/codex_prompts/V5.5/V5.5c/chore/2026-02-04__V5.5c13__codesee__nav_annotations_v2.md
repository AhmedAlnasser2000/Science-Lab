# Codex Prompt — V5.5c13 CodeSee: add NAV annotations (v2, aligned to current files)

## What is NAV (short for)?
**NAV = Navigation**. In this repo it’s a convention for searchable comment anchors like `[NAV-40]` that form an in-file table-of-contents.
- Humans can jump quickly by searching `NAV-`.
- Codex can navigate large files faster using these stable anchors.
- This is not a language feature—**comments only**.

## Goal
Add consistent NAV anchors to the CodeSee modules we recently created/split, with **zero behavior change**.
- Comments-only diffs.
- Avoid noisy reformatting.
- Keep tests passing.

Target files (limit scope to these):
- `app_ui/codesee/screen.py`
- `app_ui/codesee/ui/lens_palette.py`
- `app_ui/codesee/dialogs/inspector.py`
- `app_ui/codesee/dialogs/removed.py`
- `app_ui/codesee/dialogs/pulse_settings.py`

## Style (match `app_ui/main.py`)
At the top of each file, add a NAV INDEX block like:

```py
# =============================================================================
# NAV INDEX (search these tags)
# [NAV-00] ...
# [NAV-10] ...
# =============================================================================
```

Then add section headers + regions (editor folding) at major boundaries:

```py
# === [NAV-20] Title ===========================================================
# region NAV-20 Title
...
# endregion NAV-20 Title
```

Inside large classes, add lightweight sub-markers above method clusters:

```py
# --- [NAV-40A] Dock creation / restore
# --- [NAV-40B] Persist / apply size
```

**Do not move code.** Only insert comments and (where necessary) `# region / # endregion` wrappers.

## Touchlist

### 0) Guardrails
- Comments only. No import changes, no behavior changes, no renames.
- Keep diffs small: do not run auto-format across whole files.
- Do not remove BOM/encoding markers; leave file bytes unchanged aside from added comment lines.

### 1) `app_ui/codesee/screen.py` — add NAV at real boundaries (based on current structure)
`screen.py` is ~2950 lines and has one large class + many module helpers.

Add NAV INDEX at the very top with this map (adjust titles slightly if needed, but keep numbers):

- `[NAV-00] Imports / constants`
- `[NAV-05] Stable re-exports for tests (lens palette + helpers)`
- `[NAV-20] CodeSeeScreen`
- `[NAV-30] CodeSeeScreen: graph navigation + layout persistence`
- `[NAV-40] CodeSeeScreen: lens palette integration (dock/float/pin/persist)`
- `[NAV-60] CodeSeeScreen: overlays + rendering helpers`
- `[NAV-70] CodeSeeScreen: UI density + status tick + runtime events`
- `[NAV-80] CodeSeeScreen: snapshots/diff/crash/presets (dialogs + actions)`
- `[NAV-90] Module helpers (toggle/buttons/labels/filters/spans/badges)`
- `[NAV-99] Smoke test entrypoints`

Now place section headers at these specific points (do not reorder code):

A) `[NAV-00]` above `from __future__ import annotations`
B) `[NAV-05]` above the re-export/import block that brings in:
   - `LensPaletteWidget`, `_filter_lens_tiles`, `_lens_palette_lens_ids`, `lens_palette_dock_orientation`
   - `_span_is_stuck` (imported from dialogs/inspector module)

C) `[NAV-20]` above `class CodeSeeScreen(...)` (currently near line ~79)

Inside `CodeSeeScreen`, add sub-markers immediately above these method clusters:

- `# --- [NAV-30A] graph stack / set graph / enter-subgraph` (above `_workspace_id`, `_graph_for_id`, `_enter_subgraph`, `_set_graph`)
- `# --- [NAV-30B] layout save/restore` (above `_save_layout`, `_restore_layout`)

- `# --- [NAV-40A] ensure palette widget` (above `def _ensure_lens_palette` ~line 921)
- `# --- [NAV-40B] ensure dock + apply flags` (above `def _ensure_lens_palette_dock` ~line 946)
- `# --- [NAV-40C] persist/restore dock state` (above `_persist_lens_palette_dock_state` ~line 1110 and `_restore_lens_palette_dock_state` ~line 1131)
- `# --- [NAV-40D] dock size + repaint` (above `_apply_lens_palette_dock_size` ~line 1220)

- `# --- [NAV-60A] apply runtime overlay` (above `_apply_runtime_overlay` ~line 1509)
- `# --- [NAV-60B] apply expectation badges / span overlay` (above `_apply_expectation_badges`, `_apply_span_overlay` in that area)

- `# --- [NAV-70A] UI scale / density` (above `_apply_density` ~line 1649)
- `# --- [NAV-70B] status tick` (above `_on_status_tick` ~line 1735)
- `# --- [NAV-70C] runtime event handler` (above `_on_runtime_event` ~line 2066)

- `# --- [NAV-80A] snapshot load + removed dialog + pulse settings` (above `_load_snapshot_by_path` ~line 2148)
  (This cluster includes `_open_removed_dialog`, `_open_pulse_settings`, presets, crash load/clear, etc.)

D) `[NAV-90]` add a section header above the first module-level helper `def _style_from_label...` (currently ~line 2518).
Inside the helper block, add sub-markers (do not move functions):
- `# --- [NAV-90A] toggle/button UI helpers` (style/toggle/button/combo helpers, `_format_active_total`)
- `# --- [NAV-90B] badge keys + labels + filter summaries` (badge/event helpers + label dicts)
- `# --- [NAV-90C] filters + pulse topic enablement` (`_passes_quick_filters`, `_passes_diff_filters`, `_pulse_topic_enabled`, etc.)
- `# --- [NAV-90D] span helpers` (`_node_has_active_span`, `_node_has_stuck_span`, `_span_fallback_node_id`, `_active_span_node_ids`, etc.)
- `# --- [NAV-90E] badge builders + crash helpers` (`_badge_for_check`, `_crash_badge_from_record`, `_format_crash_timestamp`, `_merge_span_badges`, `_span_titles`)

E) `[NAV-99]` above `def run_pulse_smoke_test()` (end of file)

### 2) `app_ui/codesee/ui/lens_palette.py` — NAV sections by real definitions
This file has a clear top-level layout:

Add NAV INDEX with:
- `[NAV-00] Imports / constants`
- `[NAV-10] Lens tile spec + filtering` (starts at `def _lens_palette_lens_ids` / `_lens_tile_spec` / `_filter_lens_tiles`)
- `[NAV-20] Dock orientation helper` (`lens_palette_dock_orientation`)
- `[NAV-30] Icon/pixmap cache helpers` (`_LENS_ICON_CACHE`, `_fallback_lens_pixmap`, `_lens_palette_icon_pixmap`)
- `[NAV-40] LensPaletteWidget` (class)

Place section headers immediately above those defs/classes.

### 3) `app_ui/codesee/dialogs/inspector.py`
This file has:
- `_span_is_stuck`
- `CodeSeeInspectorDialog`
- many `_format_*` helpers

Add NAV INDEX with:
- `[NAV-00] Imports / constants`
- `[NAV-10] Span helpers` (`_span_is_stuck`)
- `[NAV-20] CodeSeeInspectorDialog` (class)
- `[NAV-30] Formatting helpers` (all `_format_*` functions)

### 4) `app_ui/codesee/dialogs/removed.py`
Add NAV INDEX with:
- `[NAV-00] Imports / constants`
- `[NAV-20] CodeSeeRemovedDialog`
- `[NAV-30] Formatting helpers` (`_format_removed_nodes`, `_format_removed_edges`)

### 5) `app_ui/codesee/dialogs/pulse_settings.py`
Add NAV INDEX with:
- `[NAV-00] Imports / constants`
- `[NAV-10] Topic label helpers` (`_pulse_topic_labels`)
- `[NAV-20] `open_pulse_settings(...)` entrypoint`

## Self-verification (must do)
Automated:
- `pytest -q tests/test_codesee_*`
- `python -m compileall app_ui -q`

Manual:
- Open CodeSee screen.
- Open/close Lens Palette (dock/float/pin).
- Open Inspector + Removed dialogs.
- Open Pulse Settings dialog and close it.

## Forbidden list
- No behavior changes. Comments only.
- No method reordering.
- No import refactors.
- No whitespace-only churn across whole files.

## Model / settings
Use **GPT-5.2-Codex Medium**.

## Git checkpoint
```bash
git add -A
git commit -m "chore(V5.5c13) add NAV annotations to codesee modules"
git push
```
