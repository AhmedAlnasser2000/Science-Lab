# Codex Prompt — V5.5c13 CodeSee: declutter `screen.py` safely (no behavior changes)

## Goal
Refactor CodeSee to reduce risk and improve maintainability by splitting `app_ui/codesee/screen.py` (currently ~4k lines) into a small set of focused modules **without changing behavior** and **without breaking existing imports/tests**.

Primary outcomes:
1) `screen.py` becomes a thin orchestrator (wiring + high-level screen class only).
2) Lens Palette UI moves into `app_ui/codesee/ui/lens_palette.py`.
3) Dialogs move into `app_ui/codesee/dialogs/*`.
4) (Optional in this slice) Controllers move into `app_ui/codesee/controllers/*` **only after** steps 2–3 pass tests.
5) All existing public import paths remain stable. In particular:
   - `from app_ui.codesee.screen import CodeSeeScreen` must keep working.
   - Tests that import helpers from `app_ui.codesee.screen` must keep passing (either keep the helpers in `screen.py` or re-export them).

## Touchlist
### 0) Baseline inventory and guardrails (no edits yet)
- Confirm current CodeSee file list:
  - `app_ui/codesee/screen.py`
  - `app_ui/codesee/diagnostics*.py` and dialogs
  - `app_ui/codesee/window.py` and any `app_ui/main.py` wiring
- Confirm tests present:
  - `tests/test_codesee_*` (at least lens palette + status overflow + diagnostics)
- Create a short note listing which test imports come from `app_ui.codesee.screen` so we preserve them.

### 1) Create target subpackages (light structure; do not move existing modules yet)
Add directories (with `__init__.py` as needed):
- `app_ui/codesee/ui/`
- `app_ui/codesee/dialogs/`
- `app_ui/codesee/controllers/` (optional; only used if we reach step 4)

Keep this minimal: empty `__init__.py` files are fine.

### 2) Extract Lens Palette widget + helpers (biggest safe win)
Create `app_ui/codesee/ui/lens_palette.py` and move ONLY Lens Palette concerns from `screen.py`:
- `LensPaletteWidget`
- Lens-tile specs and filtering helpers:
  - `_lens_tile_spec`
  - `_filter_lens_tiles`
  - `_lens_palette_lens_ids`
- Icon/pixmap cache helpers:
  - `_fallback_lens_pixmap`
  - `_lens_palette_icon_pixmap`
  - `_LENS_ICON_CACHE`
- Dock orientation helper used by tests:
  - `lens_palette_dock_orientation`

In `app_ui/codesee/screen.py`:
- Import these symbols from `.ui.lens_palette`.
- Re-export any symbols tests import from `app_ui.codesee.screen` by assigning them at module scope.

Run checks:
- `pytest -q tests/test_codesee_*`

Commit checkpoint.

### 3) Extract dialogs (safe; reduces tail clutter)
Create and move dialog classes out of `screen.py`:

A) Inspector dialog
- New: `app_ui/codesee/dialogs/inspector.py`
- Move: `CodeSeeInspectorDialog` + formatting helpers it depends on.

B) Removed items dialog
- New: `app_ui/codesee/dialogs/removed.py`
- Move: `CodeSeeRemovedDialog` + its formatting helpers.

C) Pulse settings dialog (if currently implemented inline)
- New: `app_ui/codesee/dialogs/pulse_settings.py`
- Provide `open_pulse_settings(...) -> Optional[new_settings]`
- Replace the big method body in `screen.py` with a wrapper call.

In `screen.py`:
- Import these dialogs (do not change behavior; preserve signals/slots).
- Keep any test-imported helpers re-exported if tests rely on them.

Run checks:
- `pytest -q tests/test_codesee_*`

Commit checkpoint.

### 4) Optional: Extract the Lens Palette docking/control logic into a controller
Only do this if steps 2–3 are stable and tests pass.

- New: `app_ui/codesee/controllers/lens_palette_controller.py`
- Controller manipulates:
  - Dock creation/restoration/persisting
  - show/hide/float/pin behavior
  - click-outside / Esc-close wiring (if embedded in `eventFilter`)
- Use `typing.TYPE_CHECKING` to avoid import cycles.

Run checks:
- `pytest -q tests/test_codesee_*`

Commit checkpoint.

### 5) Thin out `screen.py` into “orchestrator only”
After moves, ensure:
- `screen.py` contains:
  - `CodeSeeScreen` class
  - minimal glue methods
  - stable re-exports for tests (only what is necessary)

### 6) Update docs prompt index (workflow hygiene)
- Add this prompt doc to `docs/codex_prompts/INDEX.md` under `V5.5c` → `chore/` (or `patch/`).
- Store the prompt file in:
  - `docs/codex_prompts/V5.5/V5.5c/chore/` (preferred)

## Forbidden list
- Do NOT change `CodeSeeScreen` import path or rename it.
- Do NOT rename/move CodeSee modules outside `app_ui/codesee/` in this slice.
- Do NOT change runtime behavior; this slice is mechanical extraction + wiring only.
- Do NOT “big bang” split into many files at once. Follow steps 2 → 3 → (optional 4).
- Do NOT break tests by forcing test rewrites. Prefer re-exporting in `screen.py`.

## Self-verification (must do)
Automated:
1) `pytest -q tests/test_codesee_*`
2) `python -m compileall app_ui -q`

Manual:
- Launch CodeSee screen, open/close Lens Palette (show/hide/float/dock/pin).
- Open Inspector/Removed dialogs.
- Trigger “More → Diagnostics” and ensure it still opens.

## Model / settings
Use **gpt-5.2 (Codex)** with **reasoning effort = medium**.

## Git checkpoints (use after each step that passes tests)
After Step 2:
```bash
git add -A
git commit -m "chore(V5.5c13) extract CodeSee lens palette into ui module"
git push
```

After Step 3:
```bash
git add -A
git commit -m "chore(V5.5c13) extract CodeSee dialogs from screen.py"
git push
```

After optional Step 4:
```bash
git add -A
git commit -m "chore(V5.5c13) move lens palette docking logic into controller"
git push
```

Final polish (INDEX update, small cleanups):
```bash
git add -A
git commit -m "chore(V5.5c13) codesee screen declutter polish and index update"
git push
```
