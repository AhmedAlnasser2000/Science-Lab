# 2026-01-21 — V5.5c10.1 — CodeSee: DockWidget drag-to-float + dock-anywhere (fix/patch)

**MODEL:** gpt-5.2-codex  
**model_reasoning_effort:** high  
**Justification:** Current Lens Palette “dock” behavior is limited (right-only) and floating/drag-to-float is not working. This likely indicates the palette is not hosted as a true `QDockWidget` in a `QMainWindow`, or the dock title bar has been replaced (breaking Qt’s drag mechanics). Needs careful recon + targeted patch to restore native docking behavior without regressing the box palette UI or reintroducing recursion loops.

---

## Context / Reported behavior

- Palette **only docks to the right**.
- Palette **does not float** via click-drag like normal Windows docking.
- Desired behavior:
  - **Click-drag the palette’s top/title area** to undock → it becomes a floating tool window.
  - While dragging, drop left/right/bottom/top to dock (Qt docking overlays/rubber-band).
  - Resizable when docked and when floating.

Videos provided by user show (1) broken behavior and (2) expected Windows docking feel.

---

## Goal

1) Make Lens Palette a **real dock tool**:
   - Dock to **left/right/bottom/top** (at least L/R/B; top optional).
   - **Drag-to-float** works by default (native dock title bar drag behavior).
   - Floating palette window is resizable and behaves like a tool window.

2) Preserve:
   - Box palette UI design (header/search/grid/footer inside content).
   - Safety fixes already landed:
     - `PHYSICSLAB_CODESEE_DISABLE`
     - non-reentrant `sys.excepthook` formatting guard
     - pin recursion fix (`QSignalBlocker` around programmatic pin sync)

3) Avoid:
   - Any resize “ratchet” / window size runaway.
   - Any new signal recursion loops.

---

## Touchlist

- `app_ui/codesee/screen.py` (palette widget + host wiring)
- CodeSee host QMainWindow for embedded and “Open in Window” variants (whatever file owns the CodeSee `QMainWindow`)
- `app_ui/codesee/view_config.py` (only if needed for state persistence / reset)
- Optional: small test verifying persistence keys are bytes/base64 strings only

---

## Forbidden list

- Do NOT remove CodeSee disable flag / excepthook guard / pin QSignalBlocker fix.
- Do NOT redesign the palette content UI.
- No refactors outside CodeSee.

---

## Recon checklist (must do before editing)

### A) Confirm the host is a QMainWindow
Find where CodeSee screen is mounted. Verify:
- There is a `QMainWindow` (or subclass) that owns the CodeSee UI.
- Lens palette is attached via `addDockWidget(...)`.

If the host is NOT QMainWindow (e.g., QWidget with layouts), convert the CodeSee host container to a QMainWindow (inside the CodeSee screen if necessary), so docking works.

### B) Confirm the palette is truly a QDockWidget
Search for:
- `QDockWidget`
- `addDockWidget`
- `setAllowedAreas`
- `setFeatures`
- `setTitleBarWidget`

If palette is not a QDockWidget → implement it as one.

### C) Check if `setTitleBarWidget(...)` is used
If a custom title bar widget is set on the dock widget, Qt drag-to-float will usually stop working.

Preferred fix:
- **Do not use `dock.setTitleBarWidget(custom)`** for the palette.
- Keep native title bar to preserve drag behavior.
- Put the “box palette header” INSIDE the dock widget content (it already is). Title bar can be minimal.

If you must keep a custom title bar for aesthetics, implement a lightweight drag handler:
- On mouse press/move in custom header, call `dock.setFloating(True)` and move the dock window following cursor.
But prefer native title bar.

### D) Verify dock options
Ensure:
- `dock.setFeatures(QDockWidget.DockWidgetMovable | QDockWidget.DockWidgetFloatable | QDockWidget.DockWidgetClosable)`
- `dock.setAllowedAreas(Qt.LeftDockWidgetArea | Qt.RightDockWidgetArea | Qt.BottomDockWidgetArea | Qt.TopDockWidgetArea)`
- `mainWindow.setDockOptions(QMainWindow.AnimatedDocks | QMainWindow.AllowNestedDocks | QMainWindow.AllowTabbedDocks | QMainWindow.GroupedDragging)`

Also confirm no code locks it right-only, like always calling `addDockWidget(Qt.RightDockWidgetArea, dock)` on every refresh.

---

## Implementation steps (apply based on recon outcome)

### 1) Make Lens Palette host a proper dock widget
- Create one persistent `QDockWidget` instance for the palette.
- Add it once to the CodeSee main window.
- Do NOT recreate it on each open/close; just show/hide it.

### 2) Restore drag-to-float
- Ensure native title bar is present:
  - Remove any `setTitleBarWidget(...)` usage for the palette dock.
- If there is no title bar visible due to styling, keep it but make it thin; DO NOT disable it.

### 3) Multi-area docking
- Set allowed dock areas to include L/R/B (and Top if desired).
- Add dock to a reasonable default area (Right), but allow user to move it.

### 4) Pin button behavior with dock widget
Pin should not fight docking:
- Pin toggle maps to floating state:
  - Pinned → `dock.setFloating(False)`
  - Unpinned → `dock.setFloating(True)` and `dock.raise_()`
- Sync pin checkbox based on `dock.topLevelChanged(bool)` using `QSignalBlocker` to avoid recursion (keep the fix).

### 5) Persist & restore state safely (if already implemented, verify it works)
- Use `saveState/restoreState` for dock layout
- `saveGeometry/restoreGeometry` for floating size/position
- Store base64 strings in view_config; ignore invalid data.
- Critical: do NOT persist while in the middle of programmatic state sync to avoid loops.

### 6) No resizing runaway
- Remove any `adjustSize()` calls on main window or dock window.
- Avoid “incremental min height” logic that grows over time.
- Ensure palette content uses scroll area and expanding size policies.

---

## Instrumentation (debug-only, minimal)
If `PHYSICSLAB_CODESEE_DEBUG=1`, print ONE line after palette setup:
- dock features flags, allowed areas mask, floating state, visible state, dock area.

This helps confirm we’re truly using QDockWidget.

---

## Auto-verify

- `python -m compileall -q app_ui`
- `pytest -q`

---

## Manual verify (Windows)

1) Run `python -m app_ui.main`
2) Open CodeSee embedded.
3) Lens Palette:
   - drag the dock title bar: it should detach and float.
   - drag floating palette to left/bottom/right: it docks.
   - resize docked area via splitter.
   - resize floating palette via window borders.
4) Repeat in “Open in Window”.
5) Restart app: placement persists.

---

## Commit

`fix(V5.5c10.1) restore Lens Palette drag-to-float and multi-area docking`

Git checkpoint commands:
```
git add -A
git commit -m "fix(V5.5c10.1) restore Lens Palette drag-to-float and multi-area docking"
git push
```
