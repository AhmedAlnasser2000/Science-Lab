# 2026-01-20 — V5.5c8 — CodeSee stability hotfix: stop recursion crash + stop window growth

**MODEL:** gpt-5.2-codex  
**model_reasoning_effort:** high  
**Justification:** The app is currently unstable on Windows (RecursionError + repeated exception hook + UI “keeps getting bigger”). This requires careful Qt/layout reasoning and defensive error-handling to restore a usable app state.

---

## Goal

1) **App must always launch and remain usable** even if CodeSee palette/config/icon systems fail.  
2) **Eliminate recursion/exception-hook spirals** (no repeated tracebacks, no formatting recursion).  
3) **Stop top-level window growth** caused by Lens Palette rebuild/resize (pinned/unpinned, search typing, More/Less).  
4) Keep the Lens Palette feature (launcher + box palette UI) but make it stable and predictable.

---

## Context / current symptoms

### A) RecursionError on launch / persistent console spam
- User sees repeated stack traces; `RecursionError: maximum recursion depth exceeded`.
- Stack includes `app_ui/codesee/runtime/hooks.py` in the `sys.excepthook` handler while formatting exceptions.
- Previous fixes attempted in `icon_pack.py`, `view_config.py`, and `screen.py` logging, but error persists and may occur **even when user isn’t interacting with the palette**.

### B) Lens Palette grid often blank / “empty message” not visible
- Lens dropdown proves lenses exist (Atlas/Platform/Content/Bus/Extensibility/Dependencies).
- Palette shows nothing under search (even empty-state banner sometimes absent).

### C) Window growth / UI keeps getting bigger
- After opening/pinning palette and typing/toggling, the CodeSee window or whole app grows repeatedly.

---

## Touchlist (allowed to edit)

- `app_ui/codesee/runtime/hooks.py`
- `app_ui/codesee/screen.py`
- `app_ui/codesee/view_config.py`
- `app_ui/codesee/icon_pack.py`
- Any minimal helper in `app_ui/codesee/` needed to make CodeSee **fail-safe**
- Tests: `tests/` (add a small deterministic non-Qt unit test if possible)

---

## Forbidden list (do NOT touch)

- `kernel/`, `core_center/`, `runtime_bus/`, `content_system/`, packaging workflows, or broad refactors.
- Do not redesign CodeSee beyond stabilizing the existing Lens Palette.

---

## Required fixes

### 1) Add a hard “CodeSee safe mode” to unblock the app immediately
Implement **one** environment variable gate:
- `PHYSICSLAB_CODESEE_DISABLE=1`

Behavior:
- If set, CodeSee should **not** install its `sys.excepthook`, and CodeSee screen should either not be available or should open with a minimal “disabled” message.
- This is a *circuit breaker* so the user can run the app even when CodeSee is broken.

Also add an **automatic fallback**:
- If CodeSee init throws an exception, catch it at the top-level CodeSee entry (where CodeSee is registered/created) and:
  - print a single concise line to stderr,
  - disable CodeSee for the remainder of the session (same effect as the env var),
  - keep the rest of the app running.

### 2) Fix `sys.excepthook` recursion and make it non-reentrant
In `app_ui/codesee/runtime/hooks.py`:
- Add a module-level reentrancy guard flag, e.g. `_IN_SYS_HOOK = False`.
- In the hook:
  - If `_IN_SYS_HOOK` is already true, write a *single-line* fallback to stderr and return.
  - Wrap `traceback.format_exception(...)` in `try/except (RecursionError, Exception)`.
  - On formatting failure, output a minimal fallback (type + repr + message), **no deep formatting**.
- Never call anything in the hook that might itself raise (no palette logging helpers, no config reads, no icon lookups).

Acceptance criteria:
- If an exception happens, you see at most **one** printed report per exception, no infinite spam.
- A RecursionError does not cause the hook to recurse.

### 3) Stop window growth: make palette resizing local (never resizes the main window)
In `app_ui/codesee/screen.py` (Lens Palette widget and its host/container):

**Rules:**
- Never call `adjustSize()` on the main window or any ancestor of the palette.
- Avoid “min-height ratchet”: don’t increase minimum sizes repeatedly on rebuild.
- Ensure the palette content is in a **scroll area** and uses `setWidgetResizable(True)`.

Concrete guidance:
- Palette root should have a sane `setSizePolicy(QSizePolicy.Preferred, QSizePolicy.Preferred)`.
- Palette scroll area should have a stable min height (compact vs expanded), but:
  - prefer `setMaximumHeight()` (caps growth) instead of unbounded `setMinimumHeight()` increases,
  - use a single source of truth for compact/expanded height, not additive bumps.
- For pinned mode, the host should allocate space but **not** propagate palette height changes into the top-level window:
  - use `QSizePolicy.Ignored` or `Maximum` on the palette container if needed,
  - ensure the palette container sits in a layout region that can scroll/clip without resizing the window.

Add debug-gated logs (same env var as before) that print *once per user action*:
- palette mode (pinned/unpinned), compact/expanded, current min/max heights
- ensure logs are not printed on every paint/layout pass

Acceptance criteria:
- Repeated pin/unpin, More/Less, and typing do **not** enlarge the top-level window.

### 4) Fix “blank grid” and missing empty-state message deterministically
Make the palette grid derive from the lens combo model **every time** and show an always-visible status line:
- “Showing N lenses” / “No lenses available (Refresh)” / “No matches for ‘query’”.

Implementation requirements:
- After building tiles, compute:
  - `available_lenses_total`
  - `filtered_count`
  - `tiles_created`
- Render the status line in a fixed-height area under the search bar so it cannot be hidden by the grid clipping.

Also ensure tile creation never depends on SVG/icon availability:
- If icon pixmap fails, use a fallback pixmap (or a simple placeholder).

---

## Auto-verify

Run:
- `python -m compileall -q app_ui`
- `python -m pytest -q`

Add at least **one** tiny non-Qt unit test (deterministic) if possible:
- Example: view_config sanitization ensures persisted fields are JSON-serializable primitives
- Example: hook reentrancy guard prevents repeated formatting calls (simulate calling hook twice)

---

## Manual verify (Windows)

1) Launch:
   - PowerShell:
     - `$env:PHYSICSLAB_CODESEE_DEBUG=1`
     - `python -m app_ui.main`
2) Open CodeSee (embedded and “Open in Window”).
3) Open Lens Palette:
   - Verify status line shows counts.
   - Type `pla` → should show filtered results or “No matches…”
4) Pin/unpin + toggle More/Less 10x.
   - Window must not keep growing.
5) If anything throws, app should remain usable; CodeSee may disable itself gracefully.

---

## Git checkpoint (after fix is verified)

Use exactly:
- `git add -A`
- `git commit -m "fix(V5.5c8) stabilize CodeSee lens palette and prevent recursion/window growth"`
- `git push`
