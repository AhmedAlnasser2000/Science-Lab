# Model
gpt-5.2-codex — reasoning_effort=medium

## Why this choice
This is a small, targeted UI correctness fix inside CodeSee (badge layout + overflow pill + optional aggregation for dropdown). Medium effort is sufficient.

---

## Goal
**Fix V5.5b1:** the on-node badge overflow indicator (`5+`, `99+`) is not appearing even when many badges/icons are present (see the provided video where many speaker icons render and even overflow past the node edge).

We want:
- A hard cap on visible badges (3–4 icons max).
- When total badges exceed that cap, show an **overflow pill** on the node (e.g., `5+`, `17+`, `99+`).
- Badges must never draw outside the node’s badge strip (clip to rect).
- The existing dropdown/popover (if implemented) should list what the badges mean, ideally aggregating repeated badge types with counts.

---

## Acceptance criteria
1) If a node has **>= 5 badge items** (or equivalent total count), the node shows:
   - at most **N visible icons** (N=3 or 4)
   - an overflow pill with `X+` (capped at `99+`).
2) Visible badges do not spill outside the node boundary:
   - badge paint routine clips to the badge strip rect.
3) Clicking/hovering the badge strip / overflow pill opens a dropdown that explains:
   - each badge type (icon + label)
   - count (if >1)
   - optional timestamp (“last seen”)
4) Do not regress:
   - V5.5a edge-following pulses
   - V5.5b1 context-sticky highlight behavior

---

## Likely root cause (what to look for)
From the video/screenshot, many icons are drawn in a row and can reach/past the node edge, which usually means:
- the badge drawing loop is rendering all badges without enforcing a maximum, AND/OR
- the calculation of max-fit icons is wrong, AND/OR
- painter clipping is not enabled for the badge area.

---

## Touchlist
- CodeSee node paint routine / badge strip renderer
- Badge layout/compression helper (if you created one in V5.5b1)
- Dropdown/popover builder (to ensure it matches the compressed model)
- Unit tests: add/update one deterministic test for compression/overflow formatting

---

## Forbidden list
- No major refactors or renames
- Don’t change runtime_bus/core_center/component_runtime
- No schema/content changes
- No new dependencies

---

## Implementation steps
### 1) Centralize badge layout with a pure helper
Add a pure helper function that takes a list of badge “items” and returns:
- `visible_items` (up to N icons to paint)
- `overflow_total` (the total badge count not shown in icons OR total count beyond visible)
- `overflow_label` (e.g., `5+`, `99+`), empty string if no overflow

Recommended model:
- Represent badges as `{type, count, last_ts}` where `count>=1`.
- Compute `total = sum(count)`.
- Visible icons: pick up to N items (ordered by importance), but do not exceed available width.
- Overflow exists if `total > visible_total`.

Add a pure formatter:
- `format_overflow(total: int) -> str`:
  - total >= 99 => "99+"
  - total >= 5  => f"{total}+"
  - else => "" (or f"{total}" if you prefer, but it should only show when overflow exists)

### 2) Enforce max visible icons by COUNT and by PIXELS
Even if you select N=4, still enforce pixel fit:
- Reserve space for the overflow pill if overflow exists.
- Compute max icons that fit:
  - `max_fit = floor((badge_rect_width - reserved_pill_width) / (icon_w + gap))`
- Use `max_visible = min(N, max_fit)`.

### 3) Clip badge rendering to the strip
Before drawing badges:
- `painter.save()`
- `painter.setClipRect(badge_strip_rect)` (or a rounded-rect clip path if you already use one)
- draw visible icons + pill
- `painter.restore()`

This prevents any accidental overflow.

### 4) Ensure the overflow pill is actually drawn
Common bug: the pill’s x-position is computed beyond the node width or the pill is drawn only when `len(items) > N` rather than when `total > visible_total`.
Tie pill visibility to the computed `overflow_total`.

### 5) Dropdown uses the same compressed model
The dropdown should list **all** badge types with counts, even if not visible.
If you currently store raw repeated badges, aggregate them before rendering the dropdown:
- group by badge type, sum counts, keep max(last_ts).

---

## Tests
Add/update 1 deterministic unit test for your pure helper:
- `format_overflow(4) == ""`
- `format_overflow(5) == "5+"`
- `format_overflow(17) == "17+"`
- `format_overflow(99) == "99+"`
- `format_overflow(140) == "99+"`
And/or:
- Given 8 badges, N=4 => visible_total <= 4 and overflow_label == "8+"

No Qt scene/view in tests.

---

## Auto-verify
- `python -m compileall -q app_ui runtime_bus core_center component_runtime ui_system content_system diagnostics tools`
- `python -m pytest -q`

---

## Manual verification (based on your video)
1) Open CodeSee and reproduce a node accumulating many badges.
2) Confirm only 3–4 icons render on the node.
3) Confirm an overflow pill appears: `5+`, `12+`, etc. (cap at `99+`).
4) Confirm badges never spill past the node edge.
5) Open dropdown and verify it explains badge meanings and counts.

---

## Git checkpoint (after fix)
git add -A
git commit -m "fix(V5.5b1) codesee badge overflow pill + clipping"
git push
