# V5.5d — Milestone Specification (Codex-Ready)

**Theme:** Deep details + drill-down debugging **without canvas explosion**.  
**Priority:** Behavior + control surfaces first. Premium visuals are deferred.

This spec is intentionally detailed so Codex does **not** guess.

---

## Goal (one sentence)
Ship a stable, scalable way to inspect and debug the app’s modularity and runtime interactions by adding an **Inspector**, **Peek mode**, and **Peek-scoped Flow lenses** with strict performance budgets and clear user controls.

---

## Non-goals (explicitly NOT in V5.5d)
- Premium glow/bloom widget skin polish (defer)
- Persistent session recording + replay player (V5.5e+)
- Auto AST-based “feature extraction” across the repo (later)
- Global canvas decompression into feature-level internals (feature-level is **Peek-only**)
- Any changes to PhysicsLab app functionality outside CodeSee/diagnostic surfaces

---

## Concepts & Definitions (use these consistently)
- **Canvas**: the main CodeSee graph view (nodes/edges).
- **Inspector**: the dedicated details panel for the currently inspected item.
- **Peek mode**: an isolated view that shows *only one module (and its internals)* to avoid clutter.
- **Lens**: a toggle/overlay that shows specific info (e.g., bus connections) without changing base layout.
- **Trail mode**: cheap “activity happened” (counters + last activity + optional lightweight pulses).
- **Trace mode**: causal path for a specific request/flow (requires correlation IDs/events). In V5.5d: live + bounded only (no persistence).

---

## Deliverables (what V5.5d must ship)

### 1) Selection model (no thrash)
**Problem:** hover/pulses/activity can hijack selection and make UI unpredictable.

**Required states:**
- `selected_item`: what the user clicked on the canvas
- `inspected_item`: what the Inspector is showing
- `inspector_locked` (pin): if locked, `inspected_item` does not change when selection changes

**Rules:**
- Click on canvas sets `selected_item`.
- If not locked, Inspector follows `selected_item`.
- If locked, only explicit “Inspect” actions change Inspector.
- Hover never changes Inspector when locked.
- Pulses/activity never change selection automatically.

---

### 2) Stable identity (ItemRef)
**Problem:** object pointers become stale when graphs refresh; deep drill-down needs stable linking.

**Required:**
- Define an `ItemRef` structure: `(kind, id, namespace?)`
- Canvas ↔ Inspector communicate only using `ItemRef` (no direct pointers)

**Kinds to support (minimum in V5.5d):**
- `module`, `component`, `feature`
- `node`, `edge` (or map node->ItemRef types)
- `topic`, `endpoint` (for bus overlay)
- `subgraph` (if used)

---

### 3) Inspector (dockable panel)
**Purpose:** show deep details without turning canvas into a table.

**UI requirements:**
- Docked right by default (floating optional later)
- Header:
  - Title + type badge
  - Copy ID
  - Pin/Lock toggle
  - Back/Forward inspected history

**Tabs/Sections (minimum):**
1) **Overview**
   - human-readable name, kind, id, status badges
   - short summary text
2) **Properties**
   - key/value list (copyable)
   - small number of items; avoid huge dumps
3) **Relations** (V5.5d requires paging)
   - Lists like Contains/Owned/Uses/Depends-on/Exports (as applicable)
   - Must be paged (“Load more”)
4) **Activity** (Trail first)
   - counters, last activity timestamps
   - top active connections list (for Peek-scoped bus lens)

**Performance requirements:**
- Any list that can exceed ~200 rows must be paged.
- No building giant strings in UI thread.

---

### 4) Peek mode (isolated deep view)
**Purpose:** allow “full decompression” inside a module without polluting global view.

**Entry:**
- Double-click module/component node or context menu: “Peek”

**Peek view behavior:**
- Shows only:
  - the chosen module (root)
  - its containment tree (submodules/components/features)
- Optional toggle: “Include 1-hop external context” (off by default)

**Controls:**
- Breadcrumb: `App ▸ Module ▸ ...`
- Exit/back
- Collapse all / Reset view

**Containment expansion rules:**
- Expand/collapse only applies to **containment** edges (hierarchy).
- Cross-links (bus/deps/calls) are NOT always-on; they appear only through lenses.

**Budgets (hard caps):**
- Cap nodes added per expand action (e.g., 100–200)
- Cap total visible nodes in Peek before warning (e.g., 800–1500, configurable)

---

### 5) “Feature-level decompression” (lowest capability level)
**User need:** confirm modularity down to “feature” (e.g., settings like DPI scaling, resolution toggles, actions, endpoints).

**Requirement:**
- Within Peek, allow drilling down:
  - Module → Component → Feature Group → Feature (lowest)

**Do NOT rely on AST parsing in V5.5d.**
Instead, V5.5d should support a **Feature Descriptor feed** (manually authored or registry-derived):

**FeatureDescriptor minimum fields:**
- `feature_id` (stable)
- `display_name`
- `owner_ref` (ItemRef of module/component)
- `category` (settings/action/endpoint/policy/ui/etc.)
- optional: `gates` (profile/policy), `docs_link`, `code_anchor` (NAV)

**Rendering:**
- Features appear as nodes in Peek (not global).
- Inspector shows feature properties and relations.

---

### 6) Flow visibility (Bus lens) — Peek-scoped only
**Problem:** rail/hierarchy alone doesn’t show runtime interactions.

**Solution in V5.5d:** a Peek-scoped lens that overlays bus information safely.

**Bus lens requirements:**
- Only available in Peek (default off)
- Shows topic/endpoint hubs + edges with strict limits:
  - Top-N edges
  - “Active only” filter
  - “Errors only” filter
- Uses Trail-mode data by default (counters + last activity; pulses optional)

**Visual constraints:**
- No spaghetti: if edge count > budget, collapse into “+more” aggregators or hide until filtered.

---

### 7) Trail vs Trace tiers (cost control)
**Trail mode (required in V5.5d):**
- cheap counters + last activity
- optional simple pulses (must honor reduced motion/low perf)

**Trace mode (optional hooks in V5.5d; deeper in V5.5e):**
- bounded in-memory ring buffer of TraceEvents
- UI can select a trace and highlight path inside Peek
- no persistence / recording to disk (V5.5e)

---

### 8) Performance / accessibility tiers (must exist)
All animated/overlay features must obey a single policy/config, with at least:
- `default`
- `reduced_motion`
- `low_perf`

**Reduced motion:**
- no continuous animation
- use static badges/counters and short “flash once” (optional)

**Low perf:**
- reduced motion + stricter budgets + repaint throttling

---

## Slice plan (milestone breakdown)

### V5.5d1 (Docs) — DONE
- Human Dictionary created (plain English + real-life analogies)
- agent_dictionary organized into folders with redirect stubs
- dictionaries are living docs and updated when needed

### V5.5d2 — Foundation (Inspector shell + selection + ItemRef)
- Implement selection model (selected vs inspected + pin)
- Implement ItemRef for key entities
- Add docked Inspector with Overview + Properties
- Click node → Inspector updates

### V5.5d3 — Peek mode
- Implement Peek view with containment expand/collapse
- Breadcrumb + exit/reset
- Budgets/caps

### V5.5d4 — Relations + paging
- Relations tab with paged lists
- Basic search/filter per list

### V5.5d5 — Bus lens (Trail)
- Peek-scoped bus overlay with topic/endpoint hubs
- Active/errors filters; Top-N
- Activity tab shows trail counters + “top active connections”

### V5.5d6 — Trace hooks (optional)
- Minimal TraceEvent schema + ring buffer
- Select trace → highlight path in Peek
- No persistence

---

## Definition of Done (milestone acceptance)
A user can:
1) Click nodes in global view → Inspector reliably shows details; pin prevents thrash.
2) Peek into a module → decompress hierarchy to feature-level without global clutter.
3) Toggle bus lens in Peek → see who talks to whom with filters and budgets.
4) Browse relations/activity without UI freezes (paging).
5) Reduced motion/low perf makes the system responsive on weak machines.

---

## Verification checklist (Codex must do for each slice)
- Run the app and open CodeSee; verify Inspector updates and pin works.
- Verify Peek isolates view and budgets prevent blowups.
- Verify bus lens only affects Peek, not global.
- Verify reduced_motion / low_perf disables animations as required.
- Ensure dictionaries remain updated if new terms introduced.

---

---

## Workflow rules (required)
These rules are part of the milestone. Codex must follow them for every V5.5d slice.

### A) Checkpoint after each slice (no exceptions)
At the end of **each slice** (d2, d3, d4, d5, d6):
1) **Self-verify** using the slice’s verification checklist (and any relevant tests).
2) Produce a short “What changed” summary (files touched + user-visible behaviors).
3) **Git checkpoint**:
   - `git status` (must be clean after commit)
   - `git add -A`
   - `git commit -m "<type>(V5.5dX) <summary>"`
   - `git push`
4) If using PRs for implementation slices:
   - Open/update PR for the slice branch
   - The user reviews and merges; Codex does not merge

**Commit message convention (recommended):**
- `feat(V5.5d2) ...` for features
- `fix(V5.5dX) ...` for bug fixes
- `chore(V5.5dX) ...` for refactors/cleanup
- `docs(V5.5dX) ...` for documentation-only changes

### B) Don’t batch multiple slices into one commit
- Keep each slice focused and reviewable.
- If a slice requires multiple commits, that’s OK, but the slice must end in a clean terminal state.

### C) Always honor reduced_motion / low_perf
- Any new animations or overlays must be gated by these tiers.
- Default behavior must remain usable on low-end hardware.

---

## Model / “thinking level” guidance per slice
Codex should use the lowest reasoning level that reliably succeeds.

**Levels:**
- **mid** = medium effort (daily driver)
- **high** = for multi-file features and tricky integration
- **extra high** = only when stuck, deep debugging, or complex refactors

**Recommended levels:**
- **V5.5d2 (Foundation: selection + ItemRef + Inspector shell):** mid
- **V5.5d3 (Peek mode + budgets):** high
- **V5.5d4 (Relations + paging + filters):** mid (high if model/view complexity grows)
- **V5.5d5 (Bus lens overlays + trail activity):** high
- **V5.5d6 (Trace hooks + ring buffer):** high (extra high only if correlation/path rendering becomes tricky)

Codex should explicitly state what level it used at the start of each slice, and only escalate when necessary.



## Notes
- Premium visual polish is intentionally deferred and should not block any slice.
- Prefer predictable behavior and strict budgets over “pretty”.
