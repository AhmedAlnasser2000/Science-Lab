# Codex Prompt — V5.5d6 Workflow: Slice “Hot‑Reload” Checkpoints

> Scope note: This slice is **workflow + tooling only** (docs + small dev helper scripts). It should not change PhysicsLab runtime behavior.

## Mandatory: Safety + repo rules (READ FIRST)

1) Open and follow these files **before editing anything**:
- `AGENTS.md` (repo root) — obey skills + repo conventions.
- `docs/handbook/agent_safety_rules.md` — treat as non‑negotiable.
- `docs/handbook/workflow_rules.md` — follow the repo’s established Git/worktree rules.
- Skill: `.agents/skills/physicslab_worktrees/SKILL.md` (use when doing branch/worktree operations).

2) If any instruction conflicts, **agent_safety_rules.md wins**, then workflow_rules.md.

---

## Agent Safety Header (paste‑equivalent)

This section is copied from `docs/handbook/agent_safety_rules.md` and must be honored.

- Don’t delete user data.
- Don’t delete history.
- Don’t destroy history.
- Don’t rename things unless requested.
- Don’t reformat large files.
- Don’t “clean up” unrelated things.
- Don’t change public APIs unless asked.
- Don’t widen scope.
- Don’t touch packaging unless requested.

Before any non‑trivial change:
- Find the source of truth file(s).
- Add a quick RECON section: what you found + anchors.
- Make the smallest change that solves the problem.
- Add/adjust tests if appropriate.
- Run verification commands.

---

## Model / thinking level
Use a **high‑reasoning** Codex setting (multi‑file docs + small tooling + tests). Avoid xhigh.

---

## Goal
Implement a repo‑native workflow that lets us run **one larger slice** (per Vx.y suffix) with **explicit checkpoints (“gates”)**, so:
- Codex can stop after each gate and wait for the user’s visual confirmation (UI) or test confirmation (backend).
- Any mid‑gate refinements are captured as **amendments** inside the same prompt doc (or a linked amendments file), without requiring a separate chat rewrite.
- Temporary “agent notes / changelog / to‑do” are stored in a **scratch folder** that is easy to delete once the slice is accepted.
- We can safely roll back to a known‑good point if a later commit goes bad.

---

## Touchlist
Work only in the following areas:

### 1) Docs: workflow contract
- Add `docs/handbook/slice_hot_reload_checkpoints.md` describing:
  - What a **Gate** is.
  - UI gate vs backend gate (what to run + what evidence to record).
  - “Stop and wait” rules (Codex must pause after printing the gate summary and ask the user to continue).
  - The 3‑tries bugfix rule (attempt up to 3 fixes, then STOP and report).
  - How to record mid‑slice refinements as **Amendments** (either update the active prompt doc or create a sibling `…__amendments.md` and link it).
  - What “Finalize” means (delete scratch folder; keep only committed docs/tests).

### 2) Scratch + notes: lightweight helper (repo‑native)
Add a tiny helper in `tools/dev/` (choose one):
- Option A: `tools/dev/slice_session.py` (single file), OR
- Option B: `tools/dev/slice_session/` package with `__main__.py`.

Required features (keep it minimal):
- Stores scratch under **`.slice_tmp/<slice_id>/…`** (repo root).
- `.slice_tmp/` must be added to `.gitignore`.
- Commands (simple CLI):
  - `start <slice_id>`: creates folder + `state.json` + `notes.md`.
  - `note <text>`: appends timestamped note.
  - `gate <name> --kind ui|backend`: opens a gate record (writes `gates/<n>_<name>.md`).
  - `gate-done <name> --result pass|fail|blocked`: closes a gate record.
  - `finalize <slice_id>`: prints what would be deleted, then deletes `.slice_tmp/<slice_id>`.

The helper’s job is **not** to automate Codex; it’s to give us a consistent, local place to store “what I did / what’s pending” between gates.

### 3) Rollback guidance (no new heavy infra)
- Add a short section to `docs/handbook/slice_hot_reload_checkpoints.md` explaining safe rollback:
  - If not pushed: `git reset --hard <good>`.
  - If pushed: prefer `git revert <bad_commit>`.
  - If using the repo worktree flow, reference existing `tools/dev/*worktree*` scripts.

### 4) Prompt doc self‑amendments (mechanical convention)
Update `docs/codex_prompts/README.md` (or add a short addendum in the new handbook doc) to standardize:
- Every prompt doc gets an **Amendments** section.
- Any mid‑slice user request (“small tweak”) is appended there with a timestamp and the gate number.
- If the user withdraws the request, append “Withdrawn” and (if needed) note the rollback commit.

### 5) Tests (small + deterministic)
Add minimal unit tests under `tests/` for the new helper:
- Creates scratch directory, writes notes, writes gate file, finalize deletes.

---

## Forbidden list
- Do not change PhysicsLab runtime behavior (no changes in `app_ui/`, `core_center/`, `runtime_bus/`, `component_runtime/`, etc.).
- Do not add MCP servers, Snyk, or third‑party SaaS integrations.
- Do not introduce a complex daemon/agent.
- Do not change CI unless strictly necessary for the tests you add.

---

## Execution protocol (how you should work)
1) **RECON:** Quote the key existing rules you’re aligning with (AGENTS + workflow_rules).
2) Implement docs + helper + tests in the smallest way.
3) Verify:
   - `python -m compileall tools tests`
   - `python -m pytest -q tests -k slice_session`
4) Summarize:
   - Files changed
   - How to use the helper (3–5 commands)

---

## Git checkpoint
Follow `docs/handbook/workflow_rules.md` / the worktree skill for branch/worktree commands.
Make a local commit when complete (push optional unless user asked).

Suggested commit title:
- `chore(V5.5d6): add slice hot-reload checkpoints workflow + slice_session helper`
