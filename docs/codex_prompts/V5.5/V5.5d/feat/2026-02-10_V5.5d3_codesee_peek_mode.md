# V5.5d3 — CodeSee Peek Mode (Isolated Deep View + Budgets)

## Goal
Implement **Peek mode** for CodeSee:
- Enter Peek from a module/component node.
- Show an **isolated view** of the selected root and its **containment hierarchy** (expand/collapse like a mind map).
- Provide breadcrumb + exit/reset controls.
- Enforce strict **budgets** to prevent canvas explosion / freezes.

**No bus lens yet (V5.5d5).**  
**No Relations paging yet (V5.5d4).**  
**No premium visuals.**

---

## Touchlist (allowed)
- `app_ui/codesee/**` (primary)
- `app_ui/screens/**` *(only if CodeSee screen is located/wired there)*
- `app_ui/widgets/**` *(only if you need small shared widgets)*
- `docs/agent_dictionary/**` and `docs/human_dictionary/**` *(only if new terms appear in UI)*
- `docs/codex_prompts/INDEX.md` *(append entry for this prompt)*

---

## Forbidden list
- Do NOT modify: `core_center/**`, `runtime_bus/**`, `component_runtime/**`, `kernel/**`, `content_system/**`, `ui_system/**`
- No CI/workflow changes, no dependency changes
- No refactors unrelated to Peek mode

---

## Model / thinking level
- Codex mode: **Agent**
- Reasoning level: **high**
Rationale: multi-file view/state changes, hierarchy expansion, and performance budgets.

---

## Deliverable by end of V5.5d3
User can:
1) Select a module/component node and **Peek** into it.
2) Expand/collapse containment hierarchy inside Peek without affecting global view.
3) Use breadcrumb and exit/reset controls.
4) Hit budgets safely (no freezing); system provides clear “too many items” UI.

---

## Implementation plan

### 0) Preconditions
V5.5d2 must exist:
- ItemRef
- Inspector selection/lock/history

Peek mode will re-use ItemRef. Do not introduce a parallel identity type.

---

### 1) Add Peek state model (PeekContext)
Add a dedicated Peek state container (class/dataclass) in CodeSee UI state:

Minimum fields:
- `peek_active: bool`
- `peek_root: Optional[ItemRef]`  # module/component to peek into
- `peek_visible: set[ItemRef]`    # items currently rendered in Peek
- `peek_expanded: set[ItemRef]`   # containment nodes expanded
- `peek_breadcrumb: list[ItemRef]` (or path-like list; root-first)
- `include_external_context: bool = False`  # default off

Rules:
- When `peek_active` is True, the canvas renders **Peek graph** instead of global graph.
- Inspector remains available and continues to show inspected items (works normally inside Peek).

---

### 2) Enter Peek (UI actions)
Provide at least one reliable entry method:
- Double-click module/component node OR
- Context menu action: “Peek”

On enter:
- Set `peek_root = itemref`
- `peek_active = True`
- Initialize `peek_visible` with root + immediate containment children (bounded)
- Set breadcrumb to `[root]`
- Clear expanded set (or mark root expanded)

On exit:
- `peek_active = False`
- Clear Peek state safely
- Return to global graph view without losing selection history

---

### 3) Define containment traversal (no cross-links)
Peek expansion must traverse **containment/ownership** edges only.

Implementation requirement:
- Implement a query layer that reinforces containment semantics:
  - `get_containment_children(itemref) -> list[ItemRef]`

If CodeSee graph model doesn’t currently label containment edges:
- Add a minimal classification at graph-build time:
  - “containment edges” are those that represent ownership/hierarchy (module contains component, component contains feature group, etc.)
- Keep it minimal and stable.

Cross-links:
- Do NOT show dependency/bus/call edges by default in Peek.
- Those come later via lenses (d5).

---

### 4) Expand / collapse behavior (mind-map style)
In Peek view:
- Clicking an expand control (or double-click) expands a containment node:
  - add its children to `peek_visible`
  - add node to `peek_expanded`
- Collapsing:
  - remove its descendant subtree from `peek_visible` unless also reachable via other expanded parents (keep it simple: tree semantics preferred)
  - remove node from `peek_expanded`

Prefer **tree semantics** for d3. If the underlying model is DAG, choose a stable parent-child representation for Peek.

---

### 5) Budgets (hard caps) — REQUIRED
Define budgets (constants or config) for Peek:
- `MAX_PEEK_ADD_PER_EXPAND` (suggest 150)
- `MAX_PEEK_VISIBLE_TOTAL` (suggest 1200)

Enforcement:
- Before adding children, compute how many would be added.
- If expanding would exceed per-action cap:
  - Add only the first N children (stable order), and show “+X more (filtered)” indicator or message.
- If expanding would exceed total cap:
  - Refuse expansion and show a clear warning:
    - “Too many items in Peek. Collapse nodes or narrow scope.”

UI requirement:
- The user must see a clear message when limits are hit (status bar, toast, inline banner—use existing patterns).

---

### 6) Peek controls (breadcrumb + exit/reset)
Add a compact control strip (top-left or toolbar area):
- Breadcrumb path (clickable optional; at least visible)
- “Exit Peek” button
- “Collapse all” button
- “Reset view” button (clears expanded state, returns to root-only)
- Optional toggle (present but default off):
  - “Include 1-hop external context” (DO NOT implement external context in d3; the toggle may be disabled or “Coming later”)

---

### 7) Stale safety (graph refresh)
If the underlying graph rebuilds while in Peek:
- If `peek_root` is missing:
  - show “Peek root not found (stale).”
  - provide “Exit Peek” action
- If some visible nodes disappear:
  - safely drop them from `peek_visible`
  - do not crash

---

### 8) Update dictionaries only if new terms appear
If you add UI text like “Peek”, “Containment”, “Budget”, update:
- `docs/human_dictionary/glossary.md` with plain-English definitions
- `docs/agent_dictionary/...` for contributor-facing notes

Keep changes minimal.

---

### 9) Update `docs/codex_prompts/INDEX.md`
Append an entry for this prompt file (V5.5d3) with commit TBD.

---

## Self-verify (Codex must run)
From repo root (worktree for this slice):

1) Syntax check:
- `python -m compileall app_ui`

2) Targeted tests if present:
- `pytest -q` or `pytest -q tests/test_codesee_*`

3) Manual UI verification (required):
- Launch app → open CodeSee
- Enter Peek from a module/component node
- Expand/collapse a few levels
- Confirm global view is unaffected after Exit Peek
- Trigger budgets:
  - expand a node with many children
  - confirm no freeze + clear budget message
- Confirm Inspector still works inside Peek and pin/lock behavior remains correct

---

## Git checkpoint (end of slice)
```bash
git status
git add -A
git commit -m "feat(V5.5d3) add CodeSee peek mode with containment expansion and budgets"
git push
```
