# 2026-02-17 â€” V5.5d7 Milestone â€” CodeSee Facet Scope Controls (Selected vs Peek Graph)

## Context
We discussed facet visibility scope options:
1) **Selected-only** (facets appear only for the currently selected node)
2) **Peek-graph** (facets appear for all nodes currently visible in the focused Peek view)
3) **Both** (toggleable)

We are implementing **(1) and (2)** via a persisted setting in d7.

## Goal
Add a **user-facing facet scope setting** so users can choose *how broadly* facet nodes appear **without canvas clutter** and with **clear provenance**.

## Decisions / Constraints
- **No ring/orbit layout** for facets (keep layout simple).
- **Policy A for group/container nodes:** runtime facets (Errors/Logs/Activity/Signals/Spans/Runs) are **disabled by default** for group/container nodes.
  - This is to prevent ambiguous â€œcontainer-levelâ€ runtime data unless explicitly enabled later.
- **No modal popups** for non-peekable nodes.
  - If user double-clicks a non-peekable node, show a lightweight message/toast (â€œNo deeper graph; open in Inspector.â€).
- **No spam:** messages only occur on explicit user action (double-click / Peek). Rendering must never emit dialogs.

## Key UX semantics
### Inspect vs Peek mental model
- **Inspect** = details panel (Inspector) for a nodeâ€™s metadata, logs, etc.
- **Peek** = **focus view** (isolated graph) for drilling into structure. Peek does not replace Inspect.

### Facet scope semantics (important)
We will persist `facet_scope` with two values:
- `selected` â€” show facets for **selected node only**.
- `peek_graph` â€” show facets for **all nodes in the current focused Peek view**.

**Safety fallback:** If the user is *not* in a focused Peek view (i.e., full graph / not isolated), `peek_graph` behaves like `selected`.
This prevents the â€œfacet spaghettiâ€ you observed when enabling many facet types on the full canvas.

## Deliverables

### 1) Facet scope contract (persisted)
- Extend `ViewConfig` with a new persisted setting, e.g.:
  - `facet_scope: "selected" | "peek_graph"`
- Persist per-workspace alongside existing CodeSee settings.

**Default:** `selected` (safer/bounded). Users can switch to `peek_graph` once they understand Peek flow.

### 2) Facet settings UI
- Update the Facet Settings dialog to include a **Facet scope** selector:
  - â€œShow facets for: Selected node onlyâ€
  - â€œShow facets for: Current Peek graphâ€
- Add a quick toggle in the **canvas background right-click â†’ Facets** menu:
  - `Facet scope â†’ Selected only` / `Facet scope â†’ Peek graph`

(Quick toggle should update persistence and re-render immediately.)

### 3) Rendering behavior
When facets are enabled, compute candidate owners based on `facet_scope`:
- `selected`: only the selected node (if any)
- `peek_graph`: all nodes in the **current isolated peek graph**
  - if not in peek/focus: fall back to `selected`

Apply existing facet eligibility rules:
- **Facet/leaf nodes do not spawn further facets**.
- **Group/container nodes do not get runtime facets by default** (Policy A).

**De-dup / stability:** facet nodes must be stable and unique:
- id pattern recommendation: `facet:<owner_id>:<facet_kind>`
- changing scope must remove stale facet nodes (no duplicates left behind)

### 4) Provenance clarity (fixes ambiguity)
Facet nodes must make origin obvious **on the canvas**, not only in Inspector.

Required:
- Facet node title format: `<OwnerLabel> Â· <Facet>` (e.g., `app_ui Â· Errors`)
- Tooltip includes:
  - full `owner_id`
  - `facet_kind`
- Edge from owner â†’ facet uses a distinct edge type (e.g., `edge:facet_of`), so the relationship is visually legible.

### 5) Peekability rules
- Only nodes with structural drill-down should be peekable.
- Facet nodes are **not peekable**.
- If user tries to Peek a non-peekable node:
  - show a lightweight toast/message (no modal)
  - do not proceed

Multi-selection Peek behavior (if supported):
- Peek should operate on the **subset of peekable nodes**.
- If some are not peekable, show **one** toast summary:
  - e.g., â€œPeeked 3 nodes; skipped 2 non-peekable.â€

## Out of Scope (non-goals)
- Replacing or redesigning the overall layout algorithm.
- Adding â€œaggregate runtime facets for containersâ€ (Policy B) â€” keep it off for now.
- Adding new data sources (new log collectors, new span backends) beyond what already exists.
- Changing pulse settings unless required by the new facet scope behavior.

## Acceptance Checklist

Manual:
- Toggle facet scope in settings and observe:
  - Selected-only: facets appear only for selected node
  - Peek-graph: facets appear for all nodes in current Peek view
  - In full graph view, peek-graph behaves like selected (no explosion)
- Switching scopes does not duplicate facet nodes or leave stale nodes behind.
- Provenance is clear on-canvas (`Owner Â· Facet` + facet_of edge).
- Group/container nodes (e.g., Core Central) do **not** show runtime facets by default.
- Double-clicking a non-peekable node shows one lightweight message (no modal).

Automated:
- Add/update unit tests to confirm:
  - `ViewConfig` round-trip persistence of `facet_scope`
  - facet owner selection logic follows scope, including â€œpeek_graph fallback to selected when not in peekâ€
  - provenance label formatting for facet nodes
  - dedup/stale facet cleanup on scope change

## Suggested PR title (when implemented)
`feat(V5.5d7): add CodeSee facet scope controls (selected vs peek graph)`


## Amendments / Delta
- 2026-02-18T08:44:40Z - D7 patch set applied for clarity and compatibility.
  - Atlas messaging: when facet controls are used outside System Map/Demo, show non-modal status hint: "Facet nodes are curated for System Map (Demo) right now. Switch Source -> Demo."
  - Provenance labels: facet titles now include owner directly (owner / facet), and facet metadata now includes owner_id, owner_label, and facet_kind (with backward-compatible keys retained).
  - Facet edge compatibility preserved: edge.kind remains facet; provenance relation continues via metadata.
  - Facet glyphs: facet nodes render a small kind glyph near the title for logs/deps/errors/spans/runs/activity.

