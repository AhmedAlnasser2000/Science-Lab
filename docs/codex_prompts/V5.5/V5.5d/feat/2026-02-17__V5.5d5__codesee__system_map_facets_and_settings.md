# 2026-02-17 — V5.5d5 — CodeSee — System Map facets + settings + canvas menu (rebuild)

> **Use this as the single Codex prompt for the whole V5.5d5 slice.**  
> Scope: CodeSee only. Keep changes controlled. Avoid “chaotic” behavior drift by treating settings as the contract.

## Goal

Implement V5.5d5 (rebuild) as a **controlled improvement** of the canonical CodeSee curated view:

1) Rename the curated “Demo” **source label** to a meaningful name (e.g. **System Map**), without changing lens IDs.
2) Replace fragile bubbles/count UI for curated exploration with **facet nodes** (synthetic nodes) that open Inspector views.
3) Add **Facet settings** (density + per-facet toggles) with persistence, and a **canvas background right-click menu** to control facets quickly.
4) Make Inspector **Relations** and **Activity** minimally real (no longer placeholder text) so facets have a stable destination.
5) Enforce pulse governance:
   - Fix default fallback mismatches so runtime behavior matches `PulseSettings` defaults.
   - Do **not** introduce new pulse constants without a corresponding setting (or explicit decision to keep constant, documented).
6) Curated graph improvement: add a normal `Core Central` node that contains **only what exists today**:
   - Management Core (core_center)
   - Communication Core (runtime_bus)
   (Do **not** add Visual/Runtime Central until implemented.)

---

## Touchlist

- `app_ui/codesee/screen.py`
  - Curated source label rename (`SOURCE_DEMO` currently “Demo”).
  - Source combo wiring (where the label appears).
  - New facet settings load/save integration + refresh triggers.
  - Screen-level handlers for facet changes (invoked from canvas context menu + settings dialog).
- `app_ui/codesee/view_config.py`
  - Add `FacetSettings` to the settings contract + persistence alongside `PulseSettings`.
  - Merge/load/save into `data/workspaces/<workspace>/codesee/settings.json` (existing pattern).
  - Fix pulse fallback mismatch issues (ensure code defaults == dataclass defaults).
- `app_ui/codesee/canvas/view.py`
  - Add **canvas background** `contextMenuEvent` that appears only when right-clicking empty canvas.
  - Menu: `Facets → Off/Minimal/Standard/Expanded/Debug` + `Facets → Configure…`.
  - Route actions to `CodeSeeScreen` via the established callback pattern.
- `app_ui/codesee/canvas/scene.py`
  - Ensure pulse settings are read in a contract-consistent way (no mismatched fallbacks).
  - (Only if needed) minimal hooks for facet visuals (selection/hover should work).
- `app_ui/codesee/canvas/items.py`
  - **Do not break** node context menu; keep node-specific menu intact.
- `app_ui/codesee/ui/inspector_panel.py`
  - Replace placeholder Relations/Activity with minimal working UI components.
  - Provide API for `CodeSeeScreen` to “open Relations filtered to facet X” or “open Activity filtered to facet Y”.
- `app_ui/codesee/dialogs/`
  - Add `facet_settings.py` (new) similar style to `pulse_settings.py`.
- `app_ui/codesee/demos/demo_graphs.py`
  - Add `Core Central` node and containment edges to Management + Communication (only).
  - Add facet nodes in a controlled way (or provide metadata hooks so screen can inject them).

Tests (if needed):
- Add/extend a small deterministic CodeSee test under `tests/test_codesee_*` to ensure facet settings persistence + canvas menu action updates config and triggers refresh.

---

## Forbidden list

- Do **not** modify Rust kernel or ABI.
- Do **not** change `runtime_bus`, `core_center`, `component_runtime` behavior unless required for CodeSee UI correctness.
- Do **not** expand the curated System Map into Atlas-level node explosion.
- Do **not** rework lens registry IDs (`atlas`, `platform`, etc.). Only rename the curated **source label**.
- Do **not** introduce pulse behavior changes via hidden constants:
  - If you need a new behavior knob, add a setting + dialog control + persistence + default.
- Do **not** alter node context menu logic in `NodeItem.contextMenuEvent` except minimal safe interoperability.

---

## Model / thinking level

- **Codex** with **High** thinking level.  
  Rationale: multi-file UI + settings contract work with strict consistency requirements.

---

## Implementation plan (do all steps in this slice)

### Step 0 — Create a slice branch + add this prompt to INDEX

1) Sync and branch:
   - `git checkout main`
   - `git pull`
   - `git checkout -b work/V5.5d5-codesee-facets`

2) Add this prompt file into repo under `docs/codex_prompts/`.
3) Append an entry to `docs/codex_prompts/INDEX.md`:
   - Date, version, filename, one-line purpose (commit hash left blank for now).

Commit:
- `git add -A`
- `git commit -m "docs(V5.5d5) add Codex prompt for System Map facets + settings"`
- `git push -u origin work/V5.5d5-codesee-facets`

### Step 1 — Rename curated “Demo” source label to “System Map”

Facts from preflight report:
- “Demo” is `SOURCE_DEMO = "Demo"` in `app_ui/codesee/screen.py`.
- Demo graphs come from `app_ui/codesee/demos/demo_graphs.py`.

Requirements:
- Rename label to **System Map** (or chosen name), preserving internal behavior and IDs.
- Ensure any UI strings / selectors display the new label.
- Keep any persisted selection resilient if it used the old string (add backward-compat mapping if needed).

Commit:
- `git commit -am "feat(V5.5d5) rename curated source label to System Map"`

### Step 2 — Add `FacetSettings` contract + persistence (ViewConfig)

Add a new dataclass beside `PulseSettings` in `app_ui/codesee/view_config.py`:

- `FacetDensity` (enum-like string): `off|minimal|standard|expanded|debug`
- `enabled: Dict[str, bool]` per facet key (e.g., deps, packs, entry_points, logs, activity, spans, runs, errors, signals)
- `show_in_normal_view: bool`
- `show_in_peek_view: bool`

Defaults:
- density = `minimal`
- show_in_normal_view = True
- show_in_peek_view = True
- enabled dict default should be consistent with density preset

Persistence:
- Extend `ViewConfig` to include facet settings section in `settings.json` under workspace:
  - file already at `data/workspaces/<workspace>/codesee/settings.json`
- Implement load/merge/save using the same patterns as pulse settings.

Important:
- Make merge robust to unknown keys (ignore with warning) and missing keys (use defaults).
- Keep schema/migration lightweight: if there’s a schema manifest pattern, follow it; otherwise rely on tolerant merge.

Commit:
- `git commit -am "feat(V5.5d5) add facet settings contract + persistence"`

### Step 3 — Fix pulse settings fallback mismatches (contract enforcement)

Preflight report notes:
- `_setting_value` fallbacks in scene differ from dataclass defaults (`pulse_alpha`, `pulse_duration_ms`, etc.).

Requirement:
- Ensure runtime reads **PulseSettings** defaults consistently.
- Remove or unify any fallback values so they match dataclass defaults.
- If code needs “safe minimums/clamps”, implement them explicitly (clamp ≠ default mismatch).

Do NOT:
- Change pulse visual behavior beyond aligning defaults.
- Touch unrelated pulse logic.

Commit:
- `git commit -am "fix(V5.5d5) align pulse fallback defaults with PulseSettings contract"`

### Step 4 — Implement Inspector Relations + Activity minimal UI (no placeholders)

Current state:
- Relations and Activity are placeholder text in `app_ui/codesee/ui/inspector_panel.py`.

Requirements:
- Implement minimal working tabs that can be driven by selection:
  - **Relations**: show typed lists (contains/contained-by, depends-on/used-by, exports/entry points, pack provides/uses)
    - Provide filter/search box.
    - Provide paging pattern (reuse lens palette approach if helpful).
  - **Activity**: show bounded recent entries (can be empty initially) with a structured “source” header.
    - Must be architected so logs/spans/events can be added later without rewrite.

API requirement:
- Expose a small API on `CodeSeeInspectorPanel`:
  - `show_relations(mode: str, items: list[...], title: str, ...)`
  - `show_activity(mode: str, items: list[...], title: str, ...)`
  - plus `select_tab(name)` helper

Commit:
- `git commit -am "feat(V5.5d5) implement minimal Inspector Relations and Activity tabs"`

### Step 5 — Add Facet Settings dialog + wiring

Add `app_ui/codesee/dialogs/facet_settings.py` in the same style as `pulse_settings.py`:

Dialog content:
- Density dropdown
- Checkbox list for facets (enabled/disabled)
- Toggles: show in normal view, show in peek view
- Buttons: Apply/Cancel

Wiring:
- Add “Facet Settings…” entry under toolbar `More ▾` (prefer a View/Filters section).
- The dialog edits `ViewConfig.facet_settings`, persists, and triggers `CodeSeeScreen` refresh.

Commit:
- `git commit -am "feat(V5.5d5) add facet settings dialog and wire into CodeSee"`

### Step 6 — Add canvas background right-click menu (GraphView)

Implement `GraphView.contextMenuEvent` in `app_ui/codesee/canvas/view.py`:

Behavior:
- If right-click hits no item (`itemAt(...) is None`), show a context menu:
  - `Facets ▸`
    - Off / Minimal / Standard / Expanded / Debug
    - Configure…
- If right-click is on an item, do nothing here (node menu remains in NodeItem).

Routing:
- Use existing callback injection pattern from `CodeSeeScreen` -> `GraphScene`/`GraphView` constructor path.
- The menu actions call screen handlers like:
  - `on_set_facet_density("minimal")`
  - `on_open_facet_settings_dialog()`

Commit:
- `git commit -am "feat(V5.5d5) add canvas context menu for facet controls"`

### Step 7 — Implement facet nodes in curated System Map (no bubbles)

Goal:
- Replace bubble/count UX with explicit facet nodes for each major node in the curated System Map.

Implementation rules:
- Facet nodes are **synthetic**; keep them few and stable.
- Facets displayed are determined by `FacetSettings` (density + enabled dict + normal/peek flags).
- Do NOT create “log bloat”. A facet node is a handle; lists render in Inspector.

Interaction:
- Selecting a facet node should:
  - Keep canvas stable (no explosion).
  - Drive Inspector:
    - Deps/Packs/Entry points -> Relations tab (typed lists).
    - Logs/Spans/Activity/Runs -> Activity tab (structured list or placeholder “no data yet”).

Data sources:
- For now, use existing graph model relations (contains/edges) for Deps/Contains where available.
- Packs/entry points can be derived from existing metadata if present; otherwise show “No data” but keep structure.
- Avoid any “counts in bubbles”; counts can be optional and only if reliable.

Commit:
- `git commit -am "feat(V5.5d5) add facet nodes for System Map and inspector routing"`

### Step 8 — Curated graph grouping: add `Core Central` containing only real centrals

In `app_ui/codesee/demos/demo_graphs.py`:
- Add a normal node `Core Central`.
- Add containment edges to:
  - `Management Core` (core_center)
  - `Communication Core` (runtime_bus)

Do NOT add:
- Visual Central
- Runtime Central
until implemented.

Commit:
- `git commit -am "feat(V5.5d5) add Core Central grouping to curated System Map graph"`

---

## Verification

Run:
- `python -m compileall app_ui runtime_bus core_center component_runtime ui_system content_system`
- `python -m pytest -q tests -k codesee`
- If specific tests exist: `python -m pytest -q tests/test_codesee_*`

Manual UI checklist:
1) Open CodeSee → confirm curated source label shows **System Map** (not Demo).
2) Right-click empty canvas → `Facets` menu appears; choosing a density updates view immediately.
3) `More ▾` → `Facet Settings…` opens; changes persist after restart (workspace-scoped).
4) Selecting a module in System Map shows facet nodes per density.
5) Clicking `Deps` facet opens Inspector → Relations with a real UI (not placeholder).
6) Clicking `Logs/Activity` facet opens Inspector → Activity with structured UI (even if no data yet).
7) Pulse Settings dialog still works; defaults are consistent (no mismatched fallbacks).
8) No regressions in node right-click menu, selection, pan/zoom.

---

## Finish: update INDEX + open PR

- Update `docs/codex_prompts/INDEX.md` entry with final commit hash/notes once merged.
- Push branch and open PR (Draft if desired). Prefer **Squash & merge** with milestone title.

Suggested PR title:
- `feat(V5.5d5) CodeSee System Map facets + canvas facet menu + settings governance`
