# V5.5d2 — CodeSee Inspector Foundation (Selection + ItemRef + Panel Shell)

## Goal
Implement the **V5.5d2 foundation** for CodeSee:
- Stable **selection model** (selected vs inspected + pin/lock) with no UI thrash.
- **ItemRef** stable identity used between canvas and Inspector.
- A docked **Inspector panel shell** (Overview + Properties now; Relations/Activity placeholders).
- Clicking a node updates Inspector (unless pinned). Back/Forward inspected history.

**No Peek mode yet (that’s V5.5d3).**  
**No premium visuals.** Keep it functional and predictable.

---

## Touchlist (allowed)
- `app_ui/codesee/**` (primary)
- `app_ui/screens/**` *(only if CodeSee screen is wired here)*
- `app_ui/widgets/**` *(only if you need a shared widget helper)*
- `docs/agent_dictionary/**` and `docs/human_dictionary/**` *(only if new terms are introduced)*
- `docs/codex_prompts/INDEX.md` *(append entry for this prompt)*

---

## Forbidden list
- Do NOT modify: `core_center/**`, `runtime_bus/**`, `component_runtime/**`, `kernel/**`, `content_system/**`, `ui_system/**`
- No CI/workflow changes, no dependency changes
- No refactors unrelated to Inspector/selection

---

## Model / thinking level
- Codex mode: **Agent**
- Reasoning level: **mid**
Rationale: multi-file feature wiring but not deep architecture.

---

## Implementation plan

### 0) Locate CodeSee entry point (if paths differ)
If CodeSee is not under `app_ui/codesee/`, locate it via:
- `rg -n "CodeSee" app_ui`
- `rg -n "codesee" app_ui`
Use the existing CodeSee screen/module as the integration point; do not create a new parallel screen.

---

### 1) Add ItemRef (stable identity)
Create a small, explicit type (dataclass or NamedTuple) such as:
- `kind: str` (e.g., "node", "edge", "module", "component", "feature" — start with "node"/"edge" for now)
- `id: str` (stable within CodeSee graph model)
- `namespace: Optional[str]` (optional; default None)

Provide helpers:
- `itemref_from_node(node) -> ItemRef`
- `itemref_from_edge(edge) -> ItemRef`
- `itemref_display_name(itemref) -> str` (best-effort friendly label)

**Important:** Canvas ↔ Inspector communicates only via ItemRef (no raw pointers stored in Inspector state).

---

### 2) Selection model (predictable, pin/lock)
Add state fields (where CodeSee stores UI state):
- `selected_item: Optional[ItemRef]`
- `inspected_item: Optional[ItemRef]`
- `inspector_locked: bool`
- `inspected_history: list[ItemRef]`
- `inspected_history_index: int`

Rules:
- Click on canvas sets `selected_item`.
- If `inspector_locked == False`, also set `inspected_item` and push into history.
- If locked, clicking changes only `selected_item`, not `inspected_item`.
- Back/Forward moves through inspected history and updates `inspected_item`.
- History should not spam duplicates when repeatedly clicking the same item (dedup adjacent).

Hover must not change inspected item.

---

### 3) Build Inspector Panel widget (shell)
Create a docked right-side panel in the CodeSee screen layout.

**Header requirements:**
- Title (friendly name) + type badge (kind)
- Copy ID button (copies ItemRef.id to clipboard)
- Pin/Lock toggle (locks inspector to current inspected_item)
- Back / Forward buttons (disabled when unavailable)

**Tabs/Sections (minimum in V5.5d2):**
- Overview tab:
  - Name, kind, id
  - optional: short “summary” text placeholder
- Properties tab:
  - key/value list for a small set of properties available from the graph model
  - If data is missing, show “No properties available”

Relations and Activity may be present but are placeholders (“Coming in V5.5d4/V5.5d5”).

**Keep it fast:** no expensive recomputation. Fetch properties on-demand from the graph model using ItemRef lookups.

---

### 4) Wire canvas clicks to Inspector updates
When a node is clicked:
- compute ItemRef
- update selection model per rules above
- refresh Inspector view

If the graph rebuilds, ensure inspected_item still renders safely:
- if item no longer exists, Inspector shows “Item not found (stale)” with a clear empty state.

---

### 5) Update dictionaries only if needed
If new terms are introduced in UI labels/docs (“ItemRef”, “inspected_item”, “pin/lock”), add short entries:
- `docs/human_dictionary/glossary.md` (plain English)
- `docs/agent_dictionary/...` (implementation-facing)

Keep changes minimal for V5.5d2.

---

### 6) Update `docs/codex_prompts/INDEX.md`
Append an entry for this prompt file (V5.5d2), with “commit: TBD”.

---

## Self-verify (Codex must run)
From repo root (in the worktree for this slice):

1) Quick syntax check:
- `python -m compileall app_ui`

2) Run targeted tests if they exist:
- `pytest -q` (or at least `pytest -q tests/test_codesee_*` if present)

3) Manual UI verification (must do):
- Launch app → open CodeSee
- Click different nodes:
  - Inspector updates (Overview/Properties reflect selected item)
- Toggle Pin/Lock:
  - Inspector stays fixed while clicking other nodes
- Back/Forward:
  - moves through inspected history correctly
- Copy ID:
  - copies to clipboard (or logs a fallback if clipboard unavailable)

Record any failures and fix them before finishing.

---

## Deliverable by end of V5.5d2
- A working Inspector panel docked in CodeSee
- Stable selection/inspection behavior with Pin + history
- ItemRef used as the stable identity between canvas and Inspector
- No peek mode yet; no bus lens yet

---

## Git checkpoint (end of slice)
```bash
git status
git add -A
git commit -m "feat(V5.5d2) add CodeSee inspector foundation (ItemRef + pin + history)"
git push
```
