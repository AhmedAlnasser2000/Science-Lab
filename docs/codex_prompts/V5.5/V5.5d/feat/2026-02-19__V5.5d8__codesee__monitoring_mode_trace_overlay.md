# 2026-02-19 — V5.5d8 — CodeSee — Monitoring Mode + trace/path overlay (stateful, no time-window semantics)

> **Use this as the single Codex prompt for the whole V5.5d8 slice.**
> This slice rebuilds the “trail activity” idea into a **monitoring-first** mode: stateful (RUNNING/DEGRADED/FATAL/INACTIVE), trace-aware, and **not** driven by “last N seconds” windows.

## Goal

Make CodeSee a credible **real-time monitoring** tool by adding a dedicated **Monitoring Mode** (toggleable) that:

1) Shows **who is active vs inactive** using a **stateful status overlay** (not time-window decay).
2) Supports **trace/path highlighting** (edges + nodes) for the **current trace** (e.g., runtime_bus trace_id), replacing the aborted d5 “trail window” semantics.
3) Remains stable and low-risk:
   - No new background “meaning timers” (no “last N seconds = active”).
   - Timers may exist only for **UI repaint throttling** and existing animation loops (Scene signal timer, Screen status timer).
   - Integrate cleanly with the existing inspector/activity infrastructure (d2–d7).

---

## Touchlist

- `app_ui/codesee/screen.py`
  - Add **Monitoring Mode** toggle UI (next to Live) + status chip.
  - Persist monitoring settings via `ViewConfig`.
  - Maintain a `MonitorState` instance and apply overlay to the `GraphScene`.
  - Add minimal monitor/trace actions in View menu (clear state, pin/unpin trace).

- `app_ui/codesee/view_config.py`
  - Extend `ViewConfig` contract with:
    - `monitor_enabled: bool` (default False)
    - `monitor_follow_last_trace: bool` (default True)
    - `monitor_show_edge_path: bool` (default True)
  - Include in load/save/merge and tests.

- `app_ui/codesee/runtime/bus_bridge.py`
  - Ensure bus request/reply events provide **trace_id** data in `CodeSeeEvent.payload` (and optionally topic).
  - Do **not** add any QTimer-based semantic decay.

- `app_ui/codesee/runtime/hub.py`
  - (If needed) add minimal helpers to list recent trace IDs or expose per-trace history, but prefer keeping state in screen/local monitor.

- `app_ui/codesee/canvas/scene.py`
  - Add API to apply monitor state and trace highlights:
    - `set_monitor_states(states: dict[str, dict])`
    - `set_trace_highlight(edges: list[tuple[str,str]], nodes: set[str], *, color: QColor | None)`
  - Ensure state application is safe if nodes/edges are missing.

- `app_ui/codesee/canvas/items.py`
  - `NodeItem`: add a **monitor border** (separate from pulse highlight) with severity colors.
  - `EdgeItem`: add optional **trace highlight overlay** (do not break diff pen semantics).

Tests:
- `tests/test_codesee_view_config.py` (extend) — settings persistence for new monitor fields.
- Add new `tests/test_codesee_monitoring_mode.py` (small, deterministic) covering:
  - Node state transitions (span start/end; error -> fatal; recovery).
  - Trace path accumulation from bus events (trace_id groups; follow_last_trace behavior).

Docs:
- `docs/codex_prompts/INDEX.md` — append entry for this prompt.

---

## Forbidden list

- Do **not** reintroduce “time window = active” semantics (no “events in last X seconds” driving RUNNING state).
- Do **not** use timers to create meaning; timers are allowed only for:
  - existing signal animation loop in `GraphScene` (33ms)
  - existing screen status tick (1s)
  - repaint throttling / debounce
- Do **not** expand curated System Map into Atlas-level explosion.
- Do **not** change lens IDs, snapshot formats, or non-CodeSee systems.
- Do **not** modify kernel ABI or add new cross-system dependencies.

---

## Model / thinking level

- **Codex** with **Medium** thinking level.
  - Rationale: multi-file UI + state logic, but should stay additive and controlled (no architecture refactor).
  - Bump to High only if tests reveal subtle Qt repaint/state problems.

---

## Implementation plan (do all steps in this slice)

### Step 0 — Slice session + branch + INDEX

Use the V5.5d6 “slice hot reload checkpoints” workflow.

1) Sync and branch:
   - `git checkout main`
   - `git pull`
   - `git checkout -b work/V5.5d8-codesee-monitoring-mode`

2) Start a slice session:
   - `python tools/slice_session.py start v5.5d8`

3) Add this prompt file and append to `docs/codex_prompts/INDEX.md`:
   - `| V5.5/V5.5d/feat/2026-02-19__V5.5d8__codesee__monitoring_mode_trace_overlay.md | TBD | Add CodeSee Monitoring Mode (stateful overlay + trace/path highlighting) |`

Commit (docs only):
- `git add -A`
- `git commit -m "docs(V5.5d8) add Codex prompt for CodeSee Monitoring Mode"`
- `git push -u origin work/V5.5d8-codesee-monitoring-mode`

(Optionally open a **Draft PR** now for CI.)

---

### Step 1 — ViewConfig contract for monitoring

In `app_ui/codesee/view_config.py`:

Add fields to `ViewConfig`:
- `monitor_enabled: bool = False`
- `monitor_follow_last_trace: bool = True`
- `monitor_show_edge_path: bool = True`

Rules:
- Include fields in `to_dict()` / `from_dict()` logic (where `ViewConfig` is serialized).
- Include fields in merge logic (roaming overrides should be able to override).
- Keep backward compatibility: missing fields => defaults.

Update `tests/test_codesee_view_config.py`:
- Round-trip persistence asserts for the 3 fields.

Commit:
- `git commit -am "feat(V5.5d8) add monitoring fields to CodeSee view config"`

---

### Step 2 — Monitoring state engine (pure logic)

Create `app_ui/codesee/runtime/monitor_state.py` (or `monitoring.py`) containing a pure-Python state tracker:

**Inputs**
- `CodeSeeEvent` stream from `_on_runtime_event`.
- Span records from hub (`list_active_spans`, `list_recent_spans`) for validation/repair.

**Outputs**
- `node_state[node_id] = {state, active, stuck, fatal, last_change_ts, trace_active_count?...}`
- `active_trace_id` + `trace_edges` (list of (src,dst) pairs) and `trace_nodes`.

**State semantics (no time-window decay):**
- `RUNNING`: node has ≥1 active span.
- `DEGRADED`: node has ≥1 active span marked “stuck” by the existing stuck rules (uses current time vs span timestamps) OR has repeated errors while still running.
- `FATAL`: node has a terminal failure signal (e.g., `app.error`, `app.crash`, or span end status == failed) and has not yet observed a later “good” completion.
- `INACTIVE`: none of the above.

**Recovery semantics:**
- Transition from FATAL → RUNNING if a new span starts for that node.
- Transition from FATAL → INACTIVE if a later span ends successfully and no active spans remain.

**Trace semantics:**
- On `bus.request` / `bus.reply` events, if `payload.trace_id` is non-empty:
  - If `monitor_follow_last_trace` is true: set `active_trace_id = trace_id` whenever a new trace_id appears.
  - Track edges from `event.source_node_id -> event.target_node_id` when both exist.
  - Maintain a bounded list per trace (e.g., last 200 edges) but do not decay by time.

Provide methods:
- `on_event(event: CodeSeeEvent) -> None`
- `tick(now: float) -> None` (recompute stuck flags, but without window/decay)
- `clear()`
- `pin_trace(trace_id: str)` / `unpin_trace()` (optional; implement if easy)

Add `tests/test_codesee_monitoring_mode.py`:
- Create a MonitorState; feed span start/end events; assert state transitions.
- Feed bus events with trace_id; assert active_trace_id and edge list.

Commit:
- `git add -A`
- `git commit -m "feat(V5.5d8) add monitoring state engine for CodeSee"`

---

### Step 3 — BusBridge supplies trace_id in event payload

In `app_ui/codesee/runtime/bus_bridge.py`:

- When publishing `EVENT_BUS_REQUEST` / `EVENT_BUS_REPLY`, include:
  - `payload={"trace_id": envelope.trace_id, "topic": envelope.topic}`

Constraints:
- Keep payload small (strings only).
- Do not change existing kind names.

Commit:
- `git commit -am "feat(V5.5d8) include trace_id in CodeSee bus events"`

---

### Step 4 — Canvas overlay plumbing (Node + Edge visuals)

#### 4A) NodeItem monitor border

In `app_ui/codesee/canvas/items.py`:
- Add fields to `NodeItem`:
  - `_monitor_strength: float`
  - `_monitor_color: QColor`
- Add setter: `set_monitor(strength: float, color: QColor | None)`
- In `paint()`, draw an additional rounded-rect border (distinct from pulse highlight) when `_monitor_strength > 0`.

Color mapping (fixed):
- RUNNING: green (#2f9e44)
- DEGRADED: yellow (#f59f00)
- FATAL: red (#e03131)
- INACTIVE: no border

#### 4B) EdgeItem trace highlight

In `EdgeItem`:
- Store base pen.
- Implement an overlay draw in `paint()` when trace-highlight is active.
- Keep diff pen semantics intact (diff_state still determines base pen).

#### 4C) GraphScene application

In `app_ui/codesee/canvas/scene.py`:
- Add:
  - `set_monitor_states(states: dict[str, dict])` → call `NodeItem.set_monitor(...)` and optionally add a status badge entry (key: "monitor").
  - `set_trace_highlight(edges, nodes, color=...)` → highlight matching EdgeItem(s) and optionally tint nodes.

Badge semantics:
- Add at most **one** monitor badge per node with:
  - key = `monitor`
  - label = `Monitor state`
  - detail = `RUNNING/DEGRADED/FATAL`
  - color = state color

Commit:
- `git add -A`
- `git commit -m "feat(V5.5d8) add monitor + trace highlight rendering to CodeSee canvas"`

---

### Step 5 — CodeSeeScreen Monitoring Mode UI + integration

In `app_ui/codesee/screen.py`:

1) Add a **Monitor** toggle button next to Live in the source row:
   - checkable `QToolButton` labeled `Monitor`
   - tooltip: “Monitoring Mode: stateful activity + trace path (no time-window semantics)”

2) Wire toggle to `ViewConfig.monitor_enabled` and persist.

3) Maintain a `MonitorState` instance:
   - Initialize when screen is created.
   - In `_on_runtime_event`, call `monitor.on_event(event)`.
   - In `_on_status_tick`, call `monitor.tick(...)` and apply to scene.

4) Apply overlay only when:
   - monitor_enabled is true, AND
   - a graph is rendered (scene has nodes)

5) Provide actions:
   - View menu → `Monitoring → Clear state` (calls `monitor.clear()` and clears scene overlays)
   - View menu → `Monitoring → Follow last trace` (checkable, persisted)
   - View menu → `Monitoring → Show edge path` (checkable, persisted)

6) Status chip:
   - In the mode/status row, show a chip similar to Diff Mode when monitor is enabled.
   - If an active trace exists, include short id (first 8 chars) in the chip text.

No regressions:
- Diff mode must still work.
- Peek/Inspector must still work.
- Live pulses remain governed by `PulseSettings`.

Commit:
- `git add -A`
- `git commit -m "feat(V5.5d8) add Monitoring Mode toggle and scene integration"`

---

## Verification

### Automated

Run:
- `python -m compileall app_ui core_center runtime_bus tools`
- `pytest -q tests/test_codesee_*.py tests/test_slice_session.py`

Add any new tests needed to keep the suite stable and deterministic.

### Manual UI checklist

1) Open CodeSee → System Map.
2) Toggle **Live**: pulses should still appear normally.
3) Toggle **Monitor**:
   - Nodes with active spans should show **green** border.
   - Inject an error event (or use an existing failing action) → node turns **red** (FATAL) and stays until a successful run/recovery.
   - Long-running/stuck span shows **yellow** (DEGRADED).
4) Trigger bus activity with trace_id (e.g., run any action that generates request/reply):
   - Current trace edges should highlight.
   - Disabling “Show edge path” removes edge highlights (nodes may still show monitor states).
5) View menu → Monitoring → Clear state clears borders/highlights.

---

## Notes / reminders

- This slice is explicitly **not** rebuilding the aborted d5 “trail activity video” approach. The new contract is stateful monitoring + trace path, not time-window decay.
- Keep the implementation **tight**: prefer additive files and small, testable changes.
- If Qt repaint glitches occur, use the existing status timer for throttled refreshes; do not add new timers to make semantics.
