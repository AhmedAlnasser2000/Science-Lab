# 2026-01-06 — V5.4i — Pillars: P8 tracing contract + P7 telemetry opt-in (next batch)

Model: **gpt-5.2 (Codex extension)** — reasoning effort **high**  
Justification: introduces cross-cutting runtime “contracts” (tracing + telemetry gating) that must be deterministic, Windows-first, and safe by default.

---

## Goal

Implement **V5.4i** from the Pillars roadmap by making two more pillars “real” (non-SKIP):

- **P8 — Activity spans + runtime tracing contract**
- **P7 — Telemetry / metrics (opt-in)**

Deliverables must be deterministic and unit-testable. No network. No new deps.

---

## Touchlist

- `tools/pillars_report.py`
- `tools/pillars_harness.py` *(only if needed for stable call contract)*
- `tests/pillars/**`
- `diagnostics/**` *(preferred home for tracing/telemetry contracts)*
- `runtime_bus/**` *(only if you choose to emit spans there; keep minimal)*
- `app_ui/**` *(only if you need a tiny integration point to prove “one subsystem emits spans”)*
- `docs/**` *(short contract note if needed)*
- `docs/codex_prompts/INDEX.md` (append entry)

---

## Forbidden list

- No new third-party dependencies.
- No network / remote telemetry.
- Telemetry must be **disabled by default**.
- Do not require a running GUI for tests.
- Do not refactor unrelated subsystems.

---

## Requirements & constraints

### Data layout
- Any local telemetry/spans output must stay under established data roots (e.g., `data/roaming/**`) and must not dirty git status.

### Determinism
- Tests should not assert timestamps; instead assert “record exists / shape matches / gating works”.

### Safety & privacy
- Default behavior is “no telemetry”.
- Opt-in must require explicit config/policy change (not environment variable alone unless already established).

---

## Implementation plan

## 1) P8 — Tracing contract (REAL CHECK)

### A) Introduce a small tracing interface
Add a minimal tracing “contract” module (preferred: `diagnostics/tracing.py`):

- `Span` object with:
  - `name: str`
  - `attrs: dict[str, Any]` (optional)
  - `start_time` / `end_time` (optional; do not test exact values)
- `start_span(name, **attrs)` returning a `Span` (or context manager)
- Context manager support:
  - `with span("bus.request", topic="core.registry.get.request"): ...`

Add a default in-memory recorder:
- stores last N spans in a ring buffer (N small like 256)
- exposes:
  - `get_recent_spans() -> list[dict]`
  - `clear_spans()`

No file I/O required for V5.4i (unless you want; if you do, keep it local/off by default).

### B) Prove at least one subsystem emits spans deterministically
Pick ONE subsystem with deterministic call paths (best options):
- `tools/pillars_harness.py` run: emit spans during report build
- `runtime_bus` request/reply path: emit spans on publish/request
- A small non-UI helper in `app_ui` that can be invoked without Qt

Add 1–2 span events:
- `pillars.run` around `build_report()`
- or `bus.request` around request handler call

### C) Pillars check for P8
In `tools/pillars_report.py`, implement P8 check that verifies:
- tracing contract module exists and imports
- the contract provides a context manager / start-stop API
- a deterministic “span emission” proof exists:
  - e.g., calling a known function emits at least one span with a known name

PASS if all true, FAIL otherwise.

Evidence:
- module + function names
- sample span names captured (first few only)

---

## 2) P7 — Telemetry opt-in (REAL CHECK)

### A) Define telemetry gating as a contract
Add `diagnostics/telemetry.py` (or similar) with:
- `is_telemetry_enabled() -> bool` (default False)
- optionally `emit_metric(name, value=1, **attrs)` that is a no-op when disabled

Important: the default must be **disabled** unless a config/policy explicitly enables it.

Integrate with existing config/policy (preferred):
- If your project already has `telemetry_enabled` in policy (it appears in startup prints), treat that as the source of truth.
- If not, define a minimal config key under `data/roaming/policy.json` or existing config system (do not invent a new system; reuse current policy/config patterns).

### B) Provide a minimal “local-only” sink (optional)
Not required, but if you add a sink:
- it must write locally under data roots (e.g., `data/roaming/telemetry/metrics.jsonl`)
- still disabled by default
- tests should only validate that the sink is not used when disabled.

### C) Pillars check for P7
In `tools/pillars_report.py`, implement P7 check that verifies:
- `is_telemetry_enabled()` exists
- default is False (in a clean env / temp config)
- explicit opt-in flips it to True using the supported mechanism (config/policy)
- when disabled, `emit_metric(...)` does not write output / does not change recorded metrics
- when enabled, `emit_metric(...)` records at least one metric (in memory is fine)

PASS if defaults + opt-in behavior is correct; FAIL otherwise.

Evidence:
- default state
- opt-in mechanism used (which file/key or config source)
- sample metric name recorded (if enabled)

---

## Tests (required)

Add unit tests under `tests/pillars/` proving PASS and FAIL for P8 and P7.

### P8 tests
- PASS: calling the “proof” function emits a span with a known name
- FAIL: simulate missing module/symbol via monkeypatch import path OR return empty spans and assert FAIL reason

### P7 tests
- PASS: default disabled; opt-in enabled; metrics emitted only when enabled
- FAIL: force default to True without opt-in (should FAIL), or force output when disabled (should FAIL)

Use `tmp_path` + monkeypatch to redirect any data root/policy path if needed.

---

## Self-verification (agent must run)

- `python -m pytest -q tests/pillars`
- `python tools/pillars_harness.py --out data/roaming/pillars_reports_v54i`
- Confirm report shows **P7/P8 are PASS or FAIL (not SKIP)**.

---

## Manual verification checklist (for the user)

- Run the app: `python -m app_ui.main`
- Run pillars checks in UI:
  - System Health → Pillars → Run pillars checks
  - Confirm P7/P8 no longer show SKIP
- Confirm telemetry is OFF by default (no telemetry outputs created unless enabled)

---

## Docs workflow (required)

Append to `docs/codex_prompts/INDEX.md`:
- Date: 2026-01-06
- Version: V5.4i
- Filename: `docs/codex_prompts/2026-01-06__V5.4i__pillars__p8_tracing_contract_p7_telemetry_opt_in.md`
- One-line purpose: “Make P8/P7 real: tracing span contract + deterministic span emission; telemetry strictly opt-in; pillars checks + tests.”
- After completion: add commit hash + brief notes.
