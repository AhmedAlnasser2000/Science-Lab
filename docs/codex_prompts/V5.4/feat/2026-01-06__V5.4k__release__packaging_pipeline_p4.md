# 2026-01-06 — V5.4k — P4 Release & packaging pipeline (Windows-first)

Model: **gpt-5.2 (Codex extension)** — reasoning effort **high**  
Justification: introduces a release build pipeline + packaging scripts/specs and upgrades Pillars P4 from SKIP → real PASS/FAIL with deterministic tests.

---

## Goal

Implement **P4 — Release & packaging pipeline** end-to-end (Windows-first):

1) Add a **repeatable Windows packaging pipeline** (GitHub Actions + local script) that produces a runnable artifact.
2) Upgrade **Pillars P4** from **SKIP** to a **real check** that PASS/FAILs deterministically.
3) Keep CI stable: existing PR CI (compile + pillars tests) stays fast; packaging runs on **workflow_dispatch** and/or tags.

---

## Touchlist

- `.github/workflows/**`
- `tools/**` (new packaging scripts)
- `build/**` (pyinstaller spec or build assets)
- `tools/pillars_report.py`
- `tests/pillars/**`
- `docs/**` (short “how to build locally” note)
- `docs/codex_prompts/INDEX.md`

---

## Forbidden list

- Don’t require the packaging job to run on every PR (keep it opt-in / dispatch / tags).
- No new runtime dependencies for end users.
- Avoid invasive refactors; packaging should wrap current app layout.
- No secrets; no signing yet (that can be a later milestone).

---

## Packaging design (Windows-first, minimal, shippable)

### Target artifact
Produce a **portable ZIP** containing a single-folder app:

- `PhysicsLab/PhysicsLab.exe` (or similar)
- bundled Python + PyQt runtime (via PyInstaller one-folder build)
- required data directories included alongside the exe:
  - `content_repo/` and/or a seeded `content_store/`
  - `ui_repo/` and/or a seeded `ui_store/`
  - `schemas/` if used at runtime
  - any other required static assets

The app must start by running the equivalent of: `python -m app_ui.main` (but as an exe).

### Build approach
Use **PyInstaller** (one-folder mode) as the initial packager.

- Add `requirements-packaging.txt` (preferred) that includes:
  - `pyinstaller`
  - any small packaging-only helpers if truly needed
- Do **not** add PyInstaller to runtime requirements.

Create a local build entrypoint:
- `tools/release/build_windows.py` (or similar)
  - creates `dist/PhysicsLab/`
  - runs pyinstaller
  - copies required repo/store assets into the dist folder
  - writes a small `BUILD_INFO.txt` with build identity

Create a PyInstaller spec for reproducibility:
- `build/pyinstaller/physicslab.spec`
  - entry script should point to `app_ui/main.py` (or a small wrapper `tools/release/entry.py`)
  - ensure Qt plugins load correctly (collect binaries/data as needed)
  - prefer “onedir” over onefile for debuggability

---

## GitHub Actions (Release workflow)

Add a new workflow (name is flexible):
- `.github/workflows/release-windows.yml`

Triggers:
- `workflow_dispatch` (required)
- optional: `push` tags like `v*` (nice-to-have, but keep simple)

Steps:
1) Checkout
2) Setup Python 3.12
3) Install:
   - `pip install -r requirements-dev.txt`
   - `pip install -r requirements-packaging.txt`
4) Run:
   - `python -m pytest -q tests/pillars` (quick gate)
   - `python tools/release/build_windows.py --out dist/PhysicsLab`
5) Zip artifact:
   - `PhysicsLab_windows.zip`
6) Upload as workflow artifact

Keep it deterministic and Windows-only for now.

---

## Pillars P4 (make it REAL)

Update `tools/pillars_report.py`:

P4 PASS criteria (deterministic):
- A release workflow exists: `.github/workflows/release-windows.yml`
- A local build script exists: `tools/release/build_windows.py`
- A packaging dependency file exists: `requirements-packaging.txt`
- A spec exists: `build/pyinstaller/physicslab.spec` (or whatever you name it)

Optionally validate that the workflow contains:
- `workflow_dispatch`
- runs-on windows
- calls the build script
- uploads an artifact

P4 FAIL if any are missing.

Do **not** require the packaging workflow to successfully run in PR CI to PASS the pillar; this is presence/structure validation for now.

---

## Tests (required)

Add deterministic tests under `tests/pillars/`:

- PASS: repo contains the above files with minimal expected markers
- FAIL: missing one file → FAIL with clear reason

Keep tests file-system based (using `tmp_path` + writing minimal repo layout, or by scanning the actual repo root like existing pillars tests do).

---

## Docs

Add a short doc:
- `docs/release/windows_packaging.md`
  - prerequisites
  - `python tools/release/build_windows.py`
  - where output goes
  - how to run the produced exe

---

## Self-verify (agent must run)

1) `python -m pytest -q tests/pillars`
2) `python tools/pillars_harness.py --out data/roaming/pillars_reports_v54k`
3) (Optional local build sanity, if environment supports PyInstaller):
   - `python tools/release/build_windows.py --out dist/PhysicsLab`

---

## Manual verification (user)

- Run app normally: `python -m app_ui.main`
- System Health → Pillars → Run pillars checks
  - confirm **P4 is PASS** and no longer SKIP
- Trigger release workflow on GitHub (workflow_dispatch)
  - download artifact and confirm `PhysicsLab.exe` launches on Windows

---

## Docs prompt index

Append an entry in `docs/codex_prompts/INDEX.md` with:
- date/version/file
- one-line purpose
- fill commit hash after merge
