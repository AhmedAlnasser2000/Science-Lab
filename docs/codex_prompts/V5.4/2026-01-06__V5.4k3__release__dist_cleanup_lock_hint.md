# 2026-01-06 — V5.4k3 — Release: pre-clean dist output + friendly “locked folder” error (Windows)

Model: **gpt-5.2 (Codex extension)** — reasoning effort **low**  
Justification: small QoL + robustness improvement to local packaging; single script change.

---

## Goal

Improve local packaging developer experience by preventing PyInstaller from failing late with:

- `PermissionError: [WinError 5] Access is denied: ...\dist\PhysicsLab`

This typically happens when Windows has the output folder locked (Explorer window open, app still running, AV scan, etc.).

We want the packaging script to:

1) **Pre-clean** the target output directory *before* invoking PyInstaller.  
2) If deletion fails, **fail fast with a clear actionable message** (instead of running a long build and failing at COLLECT).

This change should be included in the same PR as V5.4k.

---

## Touchlist

- `tools/release/build_windows.py`

(Optionally) update index entry if you’re still maintaining it in this PR:
- `docs/codex_prompts/INDEX.md` (append V5.4k3 entry)

---

## Forbidden list

- No changes to `.spec` contents beyond what the script already does.
- No changes to CI workflows.
- No new runtime dependencies.

---

## Implementation details

In `tools/release/build_windows.py`:

### 1) Add a small helper to remove a directory reliably on Windows

- Use `shutil.rmtree(path, onerror=...)`
- `onerror` should clear read-only bits (`chmod`) and retry the failing op once.
- Wrap in a retry loop (e.g., 3 attempts) with short backoff (`time.sleep(0.25/0.5/1.0)`).

Pseudo:

```python
def _rmtree_best_effort(p: Path) -> None:
    ...
```

### 2) Call it before invoking PyInstaller (important)

- Determine the *final* output folder that PyInstaller will create (the `COLLECT` output).
  - In our run, PyInstaller was removing `dist\PhysicsLab`, so treat that as the target folder.
- If it exists, attempt to delete it before invoking PyInstaller.

### 3) If deletion still fails, raise RuntimeError with a clear message

Include actionable steps:

- Close Explorer windows in the output folder
- Ensure `PhysicsLab.exe` isn’t running
- Suggested commands (don’t run automatically):
  - `taskkill /IM PhysicsLab.exe /F`
  - `Remove-Item -Recurse -Force .\dist\PhysicsLab`

Also mention AV/Defender can lock files briefly; recommend retry.

### 4) Preserve current behavior otherwise

- Don’t change the PyInstaller invocation except for the pre-clean.
- Keep stdout/stderr capture.

---

## Self-verification (agent must run)

1) Pillars tests still pass:
- `python -m pytest -q tests/pillars`

2) Packaging deps (if needed):
- `python -m pip install -r requirements-packaging.txt`

3) Run packaging twice (second run is the key regression test):
- `python tools/release/build_windows.py --out dist/PhysicsLab`
- `python tools/release/build_windows.py --out dist/PhysicsLab`

Expected:
- Second run should not fail with WinError 5; script should pre-clean and proceed.

4) Manual lock simulation (optional but useful):
- Open File Explorer inside `dist\PhysicsLab` (or keep `PhysicsLab.exe` running from there) and rerun the script.
Expected:
- Script fails **early** with a friendly message explaining the lock, not a late PyInstaller stack trace.

---

## Completion note

In the completion summary, include:
- Where the pre-clean happens (function name + call site)
- The exact user-facing error message for the “locked folder” case
- Output showing the second run succeeded past the pre-clean step
